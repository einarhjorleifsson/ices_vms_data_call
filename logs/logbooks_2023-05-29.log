
R version 4.2.2 (2022-10-31) -- "Innocent and Trusting"
Copyright (C) 2022 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # How to run things ------------------------------------------------------------
> # run this as:
> #  nohup R < R/logbooks.R --vanilla > logs/logbooks_2023-05-29.log &
> lubridate::now()
[1] "2023-05-29 10:11:36 GMT"
> 
> # A brief outline --------------------------------------------------------------
> # A single logbook munging to then be used downstream for stk match
> # This script is based on merging 2020 ices datacall internal script and that
> # used in the 2019 anr-request. Added then gear corrections and other things.
> #
> # The output has the same number of records as the input. In the downstream
> # process the data used should be those where variable **use** is TRUE.
> #
> # TODO:
> #      Should check the lb_functions in the mar-package
> #      Check vids in landings - could be used to filter out wrong vids in
> #       logbooks
> #      Higher resolution of dredge than just gid == 15, domestic purpose only
> #      Higher resolution of nets than just  gid == 2, domestic purpose only
> #      Should ICES metier be set here or further downstream?
> #
> # PROCESSING STEPS:
> #  1. Get and merge logbook and landings data
> #  2. Gear corrections
> #  3. Lump some gears
> #  4. Cap effort and end of action
> #  5. Mesh size "corrections"
> #  6. Set gear width proxy
> #  7. gear class of corrected gid
> #  8. Match vid with mobileid in stk
> #  9. Add vessel information - only needed for ICES datacall
> # 10. Add metier - only needed for ICES datacall
> # 11. ICES rectangles - only needed for ICES datacall
> # 12. Anonymize vid - only needed for ICES datacall
> 
> 
> 
> YEARS <- 2022:2009
> 
> library(data.table)
> library(tidyverse)
── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.0     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.2     ✔ tibble    3.2.0
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.1     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::between()     masks data.table::between()
✖ dplyr::filter()      masks stats::filter()
✖ dplyr::first()       masks data.table::first()
✖ lubridate::hour()    masks data.table::hour()
✖ lubridate::isoweek() masks data.table::isoweek()
✖ dplyr::lag()         masks stats::lag()
✖ dplyr::last()        masks data.table::last()
✖ lubridate::mday()    masks data.table::mday()
✖ lubridate::minute()  masks data.table::minute()
✖ lubridate::month()   masks data.table::month()
✖ lubridate::quarter() masks data.table::quarter()
✖ lubridate::second()  masks data.table::second()
✖ purrr::transpose()   masks data.table::transpose()
✖ lubridate::wday()    masks data.table::wday()
✖ lubridate::week()    masks data.table::week()
✖ lubridate::yday()    masks data.table::yday()
✖ lubridate::year()    masks data.table::year()
ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors
> library(lubridate)
> library(omar)
> con <- connect_mar()
> 
> # 0. Functions -----------------------------------------------------------------
> match_nearest_date <- function(lb, ln) {
+   
+   lb.dt <-
+     lb %>%
+     select(vid, datel) %>%
+     distinct() %>%
+     setDT()
+   
+   ln.dt <-
+     ln %>%
+     select(vid, datel) %>%
+     distinct() %>%
+     mutate(dummy = datel) %>%
+     setDT()
+   
+   res <-
+     lb.dt[, date.ln := ln.dt[lb.dt, dummy, on = c("vid", "datel"), roll = "nearest"]] %>%
+     as_tibble()
+   
+   lb %>%
+     left_join(res,
+               by = c("vid", "datel")) %>%
+     left_join(ln %>% select(vid, date.ln = datel, gid.ln),
+               by = c("vid", "date.ln"))
+   
+ }
> # end: 0. Functions
> 
> # 0. ICES lingo ----------------------------------------------------------------
> metier4 <-  
+   icesVocab::getCodeList("GearTypeL4") |> 
+   as_tibble() |> 
+   janitor::clean_names() |> 
+   select(key, description)
> metier5 <-  
+   icesVocab::getCodeList("TargetAssemblage") |> 
+   as_tibble() |> 
+   janitor::clean_names() |> 
+   select(key, description)
> metier6 <-  
+   icesVocab::getCodeList("Metier6_FishingActivity") |> 
+   as_tibble() |> 
+   janitor::clean_names() |> 
+   select(key, description)
> 
> # 0. GEARS ---------------------------------------------------------------------
> GEARS <- 
+   omar::gid_orri_plus(con) |> 
+   collect(n = Inf) |> 
+   rename(gclass = gid2,
+          m4 = dcf4,
+          m5 = dcf5b)
> GEARS_trim <-
+   GEARS |> 
+   select(gid, veidarfaeri, gclass, m4, m5)
> 
> 
> # 1. Get and merge logbook and landings data -----------------------------------
> vessels <- 
+   omar::vessels_vessels(con) |> 
+   filter(!vid %in% c(0, 1, 3:5, 9999)) %>% 
+   filter(!between(vid, 3700, 4999))
> 
> ## 1.1. Old logbooks -----------------------------------------------------------
> CATCH_old <-
+   omar::lb_base(con) %>%
+   filter(year %in% YEARS) %>% 
+   # limit to Icelandic vesssels
+   inner_join(vessels %>% select(vid),
+              by = "vid") |> 
+   select(visir) %>%
+   left_join(omar::lb_catch(con) %>%
+               mutate(catch = catch / 1e3),    # catch in tonnes
+             by = "visir") %>%
+   collect(n = Inf) %>% 
+   arrange(visir, desc(catch), sid) %>%
+   # If catch is NA, assume it is zero
+   mutate(catch = replace_na(catch, 0)) %>% 
+   group_by(visir) %>%
+   mutate(total = sum(catch),
+          p = catch / total,
+          n.sid = n()) %>%
+   ungroup() |> 
+   group_by(visir) %>%
+   slice(1) %>%
+   ungroup() %>% 
+   rename(sid.target = sid)
> # sanity: should have only one record per visir id
> CATCH_old |> 
+   count(visir) |> 
+   filter(n > 1)
# A tibble: 0 × 2
# ℹ 2 variables: visir <dbl>, n <int>
> ### Mobile gear ----------------------------------------------------------------
> MOBILE_old <-
+   omar::lb_mobile(con, correct_gear = FALSE, trim = TRUE) |> 
+   filter(year %in% YEARS,
+          # only towing gear
+          gid %in% c(5, 6, 7, 8, 9, 14, 15, 38, 40)) |> 
+   # limit to Icelandic vesssels
+   inner_join(vessels %>% select(vid),
+              by = "vid") |> 
+   select(visir, vid, gid, date, t1, t2, lon, lat, datel, effort, effort_unit,
+          sweeps, plow_width) |> 
+   collect(n = Inf) |> 
+   mutate(source = "mobile",
+          date = as_date(date),
+          datel = as_date(datel))
> 
> ### Static gear ----------------------------------------------------------------
> STATIC_old <-
+   omar::lb_static(con, correct_gear = FALSE, trim = TRUE) |> 
+   filter(year %in% YEARS,
+          gid %in% c(1, 2, 3)) |> 
+   # limit to Icelandic vesssels
+   inner_join(vessels %>% select(vid),
+              by = "vid") |> 
+   select(visir, vid, gid, date, t0, t1, t2, lon, lat, datel, effort, effort_unit) |> 
+   collect(n = Inf) |> 
+   mutate(source = "static",
+          date = as_date(date),
+          datel = as_date(datel))
> 
> ### Traps ----------------------------------------------------------------------
> TRAP_old <- 
+   omar::lb_trap(con, correct_gear = FALSE, trim = TRUE) |> 
+   filter(year %in% YEARS,
+          # only towing gear
+          gid %in% c(18, 39))  |> 
+   # limit to Icelandic vesssels
+   inner_join(vessels %>% select(vid),
+              by = "vid") |> 
+   select(visir, vid, gid, date, lon, lat, datel, effort, effort_unit) |> 
+   collect(n = Inf) |> 
+   mutate(source = "trap",
+          date = as_date(date),
+          datel = as_date(datel))
> 
> ### Pelagic seine --------------------------------------------------------------
> SEINE_old <-
+   omar::lb_seine(con, correct_gear = FALSE, trim = TRUE) |> 
+   filter(year %in% YEARS,
+          # only towing gear
+          gid %in% c(10, 12))  |> 
+   # limit to Icelandic vesssels
+   inner_join(vessels %>% select(vid),
+              by = "vid") |> 
+   select(visir, vid, gid, date, t1, lon, lat, datel, effort, effort_unit) |> 
+   collect(n = Inf) |> 
+   mutate(source = "seine",
+          date = as_date(date),
+          datel = as_date(datel))
> ### Combine the logbooks -------------------------------------------------------
> LGS_old <-
+   bind_rows(MOBILE_old,
+             STATIC_old,
+             SEINE_old,
+             TRAP_old) |> 
+   left_join(CATCH_old) |> 
+   mutate(base = "old")
Joining with `by = join_by(visir)`
> LGS_old |> 
+   count(source, gid) |> 
+   left_join(GEARS |> select(gid, veidarfaeri)) |> 
+   knitr::kable(caption = "All gears: Number of records by gear")
Joining with `by = join_by(gid)`


Table: All gears: Number of records by gear

|source | gid|      n|veidarfaeri                 |
|:------|---:|------:|:---------------------------|
|mobile |   5| 260904|Dragnót 135 mm              |
|mobile |   6| 604012|Botnvarpa                   |
|mobile |   7|  60133|Flotvarpa                   |
|mobile |   8|      1|Spærlingsvarpa              |
|mobile |   9|  48348|Humarvarpa                  |
|mobile |  14|  58110|Rækjuvarpa                  |
|mobile |  15|   9500|Hörpudiskplógur/Scallop dr. |
|mobile |  38|  17031|Kúffisksplógur              |
|mobile |  40|   4217|Ígulkeraplógur              |
|seine  |  10|   1868|Síldarnót                   |
|seine  |  12|   7568|Loðnunót                    |
|static |   1| 209620|Lína                        |
|static |   2| 104481|Net                         |
|static |   3| 253232|Handfæri                    |
|trap   |  18|    230|Krabbagildra                |
|trap   |  39|   1363|Beitukóngsgildra            |
> 
> 
> ## 1.2 New logbooks ------------------------------------------------------------
> # 2023-05-25: The new logbooks are in principle a total mess
> #             Here just some quick has is done for the ICES datacall
> # [cut]
> ## 2023-05-29 Ignore above -----------------------------------------------------
> # the function flow results in slow excecution
> lb_trip_new <- function(con) {
+   tbl_mar(con, "adb.trip_v") |> 
+     select(trip_id, 
+            vid = vessel_no,
+            T1 = departure,
+            hid1 = departure_port_no,
+            T2 = landing,
+            hid2 = landing_port_no,
+            source)
+ }
> lb_station_new0 <- function(con) {
+   tbl_mar(con, "adb.station_v") |> 
+     select(trip_id,
+            station_id,
+            gid = gear_no,
+            t1 = fishing_start,
+            t2 = fishing_end,
+            lon = longitude,
+            lat = latitude,
+            lon2 = longitude_end,
+            lat2 = latitude_end,
+            z1 = depth,
+            z2 = depth_end,
+            tow_start,
+            everything())
+ }
> lb_base_new <- function(con) {
+   lb_trip_new(con) |> 
+     inner_join(lb_station_new0(con) |> 
+                  select(trip_id:tow_start),
+                by = "trip_id") |> 
+     select(vid, gid, t1:tow_start, everything()) |> 
+     mutate(whack = case_when(between(lon, 10, 30) & between(lat, 62.5, 67.6) ~ "mirror",
+                              between(lon, -3, 3) & gid != 7 ~ "ghost",
+                              .default = "ok"),
+            lon = ifelse(whack == "mirror",
+                         -lon,
+                         lon),
+            lon2 = ifelse(whack == "mirror",
+                          -lon,
+                          lon))
+ }
> 
> n_base <- 
+   lb_base_new(con) |> 
+   filter(year(t1) %in% 2021:2022) |> 
+   collect(n = Inf) |> 
+   select(vid:lat, trip_id, datel = T2, source:whack) |> 
+   mutate(date = as_date(t1),
+          datel = as_date(datel))
> 
> 
> # only data where the date fishing and vessels are not already in the old
> #  logbooks. This reduces the number of records from ~212 thousand to
> #  ~88 thousand
> n_base <-
+   n_base |> 
+   left_join(LGS_old |> 
+               select(vid, date) |> 
+               distinct() |> 
+               mutate(in.old = TRUE),
+             multiple = "all") |> 
+   filter(is.na(in.old)) |> 
+   select(-in.old)
Joining with `by = join_by(vid, date)`
> # need to remove ghost-whacks
> n_base |> 
+   count(whack)
# A tibble: 3 × 2
  whack      n
  <chr>  <int>
1 ghost   2873
2 mirror 29980
3 ok     54787
> n_base <-
+   n_base |> 
+   filter(whack %in% c("ok", "mirror")) |> 
+   select(-whack)
> # what are the sources
> n_base |> count(source)
# A tibble: 13 × 2
   source                               n
   <chr>                            <int>
 1 APP TÖFLUR                          19
 2 FRA TAKTIKAL                      6621
 3 FRA TAKTIKAL - GAFL AUTO             9
 4 Fontos raun                         79
 5 GAFL BÓK UPPFÆRÐ FRÁ TAKTIKAL        2
 6 Jóhann Gíslason raun              1108
 7 Jóhann Gíslason raun - GAFL AUTO     1
 8 PAPPÍR                             179
 9 STOKKUR                          22756
10 TRACKWELL                         1856
11 TRACKWELL BAEKUR                    27
12 Trackwell raun                   51793
13 Trackwell raun - GAFL AUTO         317
> 
> # sanity check, see if any abberrant trend in the number of sets by month
> p <-
+   bind_rows(
+   LGS_old |> select(gid, date) |> mutate(what = "old"),
+   n_base  |> select(gid, date) |> mutate(what = "new")) |> 
+   left_join(GEARS_trim |> select(gid, gclass)) |> 
+   mutate(date = floor_date(date, "month")) |> 
+   count(date, gclass) |> 
+   filter(year(date) %in% 2018:2022) |> 
+   ggplot(aes(date, n)) +
+   geom_point() +
+   facet_wrap(~ gclass, scales = "free_y")
Joining with `by = join_by(gid)`
> p
> 
> 
> # 2023-05-29: There are lot of orphan sub-information, becomes apparent if on
> #             uses inner_join below
> n_mobile <- 
+   n_base |> 
+   inner_join(
+     tbl_mar(con, "adb.trawl_and_seine_net_v") |> collect(n = Inf)
+   ) |> 
+   mutate(effort = case_when(gid %in% c(6, 7) ~ as.numeric(difftime(t2, t1, units = "hours")),
+                             gid %in% 5 ~ 1,
+                             .default = NA),
+          effort_unit = case_when(gid %in% c(6, 7) ~ "hours towed",
+                                  gid %in% 5  ~  "setting",
+                                  .default = NA)) |> 
+   rename(sweeps = bridle_length) |> 
+   select(station_id, sweeps, effort, effort_unit)
Joining with `by = join_by(station_id)`
> n_static <- 
+   n_base |> 
+   inner_join(
+     tbl_mar(con, "adb.line_and_net_v") |> collect(n = Inf)
+   ) |> 
+   mutate(dt = as.numeric(difftime(t2, t1, unit = "hours")),
+          effort = case_when(gid == 3 ~ dt,
+                             gid %in% c(2, 11, 25, 29, 91, 92) ~ dt/24 * nets,
+                             gid %in% 1 ~ hooks,
+                             .default = NA),
+          effort_unit = case_when(gid == 3 ~ "hookhours",
+                                  gid %in% c(2, 11, 25, 29, 91, 92) ~ "netnights",
+                                  gid %in% 1 ~ "hooks",
+                                  .default = NA)) |> 
+   select(station_id, effort, effort_unit)
Joining with `by = join_by(station_id)`
> 
> n_dredge <- 
+   n_base |> 
+   inner_join(
+     tbl_mar(con, "adb.dredge_v") |> collect(n = Inf)
+   ) |> 
+   mutate(effort = as.numeric(difftime(t2, t1, units = "hours")),
+          effort_unit = "hours towed",
+          plow_width = 2) |> 
+   select(station_id, plow_width, effort, effort_unit)
Joining with `by = join_by(station_id)`
> n_trap <- 
+   n_base |> 
+   inner_join(
+     tbl_mar(con, "adb.trap_v") |> collect(n = Inf)
+   ) |> 
+   mutate(dt = as.numeric(difftime(t2, t1, units = "hours")),
+          effort = dt * number_of_traps,
+          effort_unit = "trap hours") |> 
+   select(station_id, effort, effort_unit)
Joining with `by = join_by(station_id)`
> 
> n_seine <- 
+   n_base |> 
+   inner_join(
+     tbl_mar(con, "adb.surrounding_net_v") |> collect(n = Inf)
+   ) |> 
+   mutate(effort = 1,
+          effort_unit = "settings") |> 
+   select(station_id, effort, effort_unit)
Joining with `by = join_by(station_id)`
> 
> # sanity check - am i missing settings when using inner_join above
> n_base_aux <- 
+   bind_rows(n_mobile,
+             n_static,
+             n_dredge,
+             n_trap,
+             n_seine)
> nrow(n_base)
[1] 84767
> nrow(n_base_aux)
[1] 60155
> 
> n_base <-
+   n_base |> 
+   left_join(n_base_aux |>
+               mutate(orphan = "no")) |> 
+   mutate(orphan = replace_na(orphan, "yes"))
Joining with `by = join_by(station_id)`
> n_base |> 
+   count(gid, orphan) |> 
+   spread(orphan, n)
# A tibble: 14 × 3
     gid    no   yes
   <int> <int> <int>
 1     1  4339   696
 2     2  1205   640
 3     3 16290 19101
 4     5  9075   332
 5     6 25009  1139
 6     7  1598    13
 7    10   400    NA
 8    11    14    NA
 9    25  1477  2165
10    29    21     2
11    51    44    NA
12    91   166    94
13    92   517    NA
14    99    NA   430
> 
> # repeat sanity check, see if any abberrant trend in the number of sets by month
> bind_rows(
+   LGS_old |> select(gid, date) |> mutate(what = "old"),
+   n_base  |> 
+     select(gid, date) |> mutate(what = "new")) |> 
+   left_join(GEARS_trim |> select(gid, gclass)) |> 
+   mutate(date = floor_date(date, "month")) |> 
+   count(date, gclass) |> 
+   filter(year(date) %in% 2018:2022) |> 
+   ggplot(aes(date, n)) +
+   geom_point() +
+   facet_wrap(~ gclass, scales = "free_y")
Joining with `by = join_by(gid)`
> 
> 
> lb_catch_new <- function(con) {
+   tbl_mar(con, "adb.catch") |> 
+     mutate(catch = case_when(condition == "GUTT" ~ quantity / 0.8,
+                              condition == "UNGU" ~ quantity,
+                              .default = NA)) |> 
+     select(station_id = fishing_station_id,
+            sid = species_no, 
+            catch, 
+            weight, 
+            quantity, 
+            condition, 
+            catch_type = source_type)
+ }
> 
> 
> lb_catch_new(con) |> count(catch_type)
# Source:   SQL [2 x 2]
# Database: OraConnection
  catch_type       n
  <chr>        <dbl>
1 BYCA          1703
2 CATC       1009795
> 
> n_catch <- 
+   n_base |> 
+   select(station_id) |> 
+   left_join(lb_catch_new(con) |> 
+               filter(catch_type == "CATC") |> 
+               select(station_id, sid, catch) |> 
+               collect(n = Inf) |> 
+               arrange(station_id, desc(catch), sid) %>%
+               group_by(station_id) %>%
+               mutate(total = sum(catch),
+                      p = catch / total,
+                      total = total / 1e3,
+                      n.sid = n()) %>%
+               ungroup() |>
+               group_by(station_id) %>%
+               slice(1) %>%
+               ungroup()) |> 
+   select(-catch) |> 
+   mutate(total = replace_na(total, 0))
Joining with `by = join_by(station_id)`
> 
> 
> LGS_new <-
+   n_base |> 
+   left_join(n_catch)
Joining with `by = join_by(station_id)`
> 
> LGS <- 
+   bind_rows(LGS_old |> mutate(base = "old", visir_org = visir),
+             LGS_new |> mutate(base = "new")) |> 
+   # NEW VISIR
+   mutate(visir = 1:n())
> 
> # testing if vid-date by source are unique
> LGS |> 
+   select(vid, date, base) |> 
+   distinct() |> 
+   count(vid, date, base) |> 
+   filter(n > 1)
# A tibble: 0 × 4
# ℹ 4 variables: vid <int>, date <date>, base <chr>, n <int>
> LGS |> 
+   count(vid, date, base) |> 
+   ggplot(aes(date, n, fill = base)) +
+   geom_col() +
+   scale_fill_brewer(palette = "Set1") +
+   scale_x_date(date_breaks = "1 year", date_labels = "%Y")
> LGS |> 
+   # It is obvious that jiggers are largely missing in 2021
+   # filter(gid == 3) |> 
+   mutate(date = floor_date(date, unit = "month")) |> 
+   count(vid, date, base, gid) |> 
+   ggplot(aes(date, n, fill = base)) +
+   geom_col() +
+   scale_fill_brewer(palette = "Set1") +
+   scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
+   facet_wrap(~ gid, scales = "free_y")
> 
> # nrows to double-check if and where we "loose" or for that matter accidentally
> #  "add" data (may happen in joins) downstream
> n0 <- nrow(LGS)
> paste("Original number of records:", n0)
[1] "Original number of records: 1725385"
> 
> # get the gear from landings
> tmp.ln.base <-
+   omar::ln_catch(con) %>%
+   filter(!is.na(vid), !is.na(date)) %>%
+   mutate(year = year(date)) %>%
+   filter(year %in% YEARS) %>%
+   select(vid, gid.ln = gid, datel = date) %>%
+   distinct() %>%
+   collect(n = Inf) %>%
+   mutate(datel = as_date(datel),
+          gid.ln = as.integer(gid.ln))
> 
> 
> 
> tmp.lb.ln.match <-
+   LGS %>% 
+   match_nearest_date(tmp.ln.base) %>% 
+   select(visir, gid.ln) %>% 
+   # just take the first match, i.e. ignore second landing within a day
+   distinct(visir, .keep_all = TRUE)
Warning message:
In left_join(., ln %>% select(vid, date.ln = datel, gid.ln), by = c("vid",  :
  Each row in `x` is expected to match at most 1 row in `y`.
ℹ Row 409 of `x` matches multiple rows.
ℹ If multiple matches are expected, set `multiple = "all"` to silence this
  warning.
> LGS <- 
+   LGS %>% 
+   left_join(tmp.lb.ln.match,
+             by = "visir")
> # Vessels per year - few vessels in 2021 is because of records for some
> #  small vessels have not been entered
> LGS %>% 
+   mutate(year = year(date)) |> 
+   group_by(year, gid) %>% 
+   summarise(n.vids = n_distinct(vid)) %>% 
+   spread(gid, n.vids) |> 
+   knitr::kable()
`summarise()` has grouped output by 'year'. You can override using the
`.groups` argument.


| year|   1|   2|   3|  5|  6|   7|  8|  9| 10| 11| 12| 14| 15| 18|  25| 29| 38| 39| 40| 51| 91| 92| 99|
|----:|---:|---:|---:|--:|--:|---:|--:|--:|--:|--:|--:|--:|--:|--:|---:|--:|--:|--:|--:|--:|--:|--:|--:|
| 2009| 336| 128| 652| 68| 79|  34| NA| 16| 17| NA| 12| 21|  1| NA|  NA| NA|  1|  2|  5| NA| NA| NA| NA|
| 2010| 289| 140| 876| 59| 76|  60| NA| 17| 14| NA| 23| 26|  5|  1|  NA| NA|  1|  3|  5| NA| NA| NA| NA|
| 2011| 282| 165| 928| 53| 71|  89| NA| 16| 14| NA| 19| 32|  8| NA|  NA| NA|  1|  6|  1| NA| NA| NA| NA|
| 2012| 294| 170| 988| 54| 74| 105| NA| 16| 17| NA| 26| 42|  7| NA|  NA| NA|  2|  6|  4| NA| NA| NA| NA|
| 2013| 278| 152| 980| 48| 76| 103| NA| 15| 16| NA| 25| 55|  7| NA|  NA| NA|  2|  4|  3| NA| NA| NA| NA|
| 2014| 282| 132| 985| 44| 70|  98|  1| 15|  7| NA| 21| 45|  4| NA|  NA| NA|  1|  2|  2| NA| NA| NA| NA|
| 2015| 257| 141| 888| 44| 65|  67| NA| 13|  2| NA| 24| 34|  8| NA|  NA| NA|  1|  4|  3| NA| NA| NA| NA|
| 2016| 232| 280| 892| 44| 65|  34| NA| 12|  2| NA| 19| 33| 11| NA|  NA| NA|  2|  3|  4| NA| NA| NA| NA|
| 2017| 213| 295| 802| 46| 70|  32| NA|  9|  2| NA| 22| 22| NA| NA|  NA| NA| 12|  1|  4| NA| NA| NA| NA|
| 2018| 192| 268| 757| 44| 70|  27| NA| 10|  3| NA| 18| 15|  3| NA|  NA| NA| 10| NA|  3| NA| NA| NA| NA|
| 2019| 185| 286| 761| 48| 75|  22| NA|  9|  1| NA| NA| 16|  1| NA|  NA| NA|  1| NA|  2| NA| NA| NA| NA|
| 2020| 139| 152| 707| 43| 80|  21| NA|  7|  1| NA| NA| 12| NA| NA|  NA| NA| NA| NA|  2| NA| NA| NA| NA|
| 2021| 128| 130| 759| 37| 73|  21| NA|  7| 19| NA| NA| 11|  2|  7| 120|  1|  1|  1|  1| NA|  5| NA| 21|
| 2022| 118|  92| 816| 39| 72|  26| NA| NA| 22|  3| NA|  9|  1|  2| 151|  3| NA| NA| NA|  3|  6|  4| 14|
> paste("Number of records:", nrow(LGS))
[1] "Number of records: 1725385"
> LGS %>% write_rds("LGS_raw.rds")
> # rm(tmp.lb.base, tmp.lb.catch, tmp.lb.mobile, tmp.lb.static, tmp.ln.base, tmp.lb.ln.match)
> # end: Get and merge logbook and landings data
> 
> 
> # NOTE: What to do if no effort registered?? -----------------------------------
> LGS %>% 
+   mutate(has.effort = ifelse(!is.na(effort), "yes", "no")) |> 
+   count(gid, has.effort) %>%
+   spread(has.effort, n, fill = 0) |> 
+   knitr::kable(caption = "Missing effort (no) - correct once gid has been corrected")


Table: Missing effort (no) - correct once gid has been corrected

| gid|    no|    yes|
|---:|-----:|------:|
|   1|  1330| 213325|
|   2|  1640| 104686|
|   3| 22747| 265876|
|   5|   337| 269974|
|   6|  1155| 629005|
|   7|   134|  61610|
|   8|     0|      1|
|   9|     6|  48342|
|  10|     0|   2268|
|  11|     0|     14|
|  12|     0|   7568|
|  14|     5|  58105|
|  15|    55|   9445|
|  18|   137|     93|
|  25|  2174|   1468|
|  29|     2|     21|
|  38|    92|  16939|
|  39|   250|   1113|
|  40|    67|   4150|
|  51|    23|     21|
|  91|    94|    166|
|  92|     0|    517|
|  99|   430|      0|
> 
> 
> # 2. Gear corrections ----------------------------------------------------------
> gears <-
+   #tbl_mar(con, "ops$einarhj.gear") %>% collect(n = Inf) %>%
+   # 2021-08-23 changes
+   tbl_mar(con, "ops$einarhj.gid_orri_plus") %>% 
+   select(gid = veidarfaeri, gclass = gid2) %>% 
+   collect(n = Inf) %>% 
+   mutate(#description = ifelse(gid == 92, "G.halibut net", description),
+     gid = as.integer(gid),
+     gclass = as.integer(gclass))
> LGS <- 
+   LGS %>% 
+   mutate(gid.lb = gid) |> 
+   left_join(gears %>% select(gid.lb = gid, gc.lb = gclass), by = "gid.lb") %>% 
+   left_join(gears %>% select(gid.ln = gid, gc.ln = gclass), by = "gid.ln") %>% 
+   select(visir:gid.ln, gc.lb, gc.ln, everything()) %>% 
+   mutate(gid = NA_integer_,
+          gid.source = NA_character_) %>% 
+   mutate(i = gid.lb == gid.ln,
+          gid = ifelse(i, gid.ln, gid),
+          gid.source = ifelse(i, "gid.lb=gid.ln", gid.source),
+          step = ifelse(i, 1L, NA_integer_)) %>% 
+   mutate(i = is.na(gid) & gc.lb == gc.ln,
+          gid = ifelse(i, gc.lb, gid),
+          gid.source = ifelse(i, "gc.lb=gc.ln   -> gid.lb", gid.source),
+          step = ifelse(i, 2L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 15L & gid.lb %in% c(5L, 6L),
+          gid = ifelse(i, gid.ln, gid),
+          gid.source = ifelse(i, "gid.ln=15, gid.lb=5,6   -> gid.ln", gid.source),
+          step = ifelse(i, 3L, step)) %>% 
+   mutate(i = is.na(gid) & 
+            gid.ln == 21 & 
+            gid.lb == 6 &
+            !sid.target %in% c(30, 36, 41),
+          gid = ifelse(i, gid.lb, gid),
+          gid.source = ifelse(i, "gid.ln=21, gid.lb=6, sid.target != 30,36,41   -> gid.lb",
+                              gid.source),
+          step = ifelse(i, 4L, step)) %>% 
+   mutate(i = is.na(gid) &
+            gid.ln == 21 &
+            gid.lb == 6 & 
+            sid.target %in% c(22, 41),
+          gid = ifelse(i, 14, gid),
+          gid.source = ifelse(i, "gid.ln=21, gid.lb=6, sid.target = 22,41   -> 14", gid.source),
+          step = ifelse(i, 5L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 6 & gid.lb == 7 & sid.target %in% c(11, 19, 30:36),
+          gid = ifelse(i, gid.lb, gid),
+          gid.source = ifelse(i, "gid.ln=6, gid.lb=7, sid.target = 11,19,30:36   -> gid.lb", gid.source),
+          step = ifelse(i, 6L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 18 & gid.lb == 5,
+          gid = ifelse(i, gid.ln, gid),
+          gid.source = ifelse(i, "gid.ln=18, gid.lb=5   -> gid.ln", gid.source),
+          step = ifelse(i, 7L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 18 & gid.lb == 40,
+          gid = ifelse(i, gid.lb, gid),
+          gid.source = ifelse(i, "gid.ln=18, gid.lb=40   -> gid.lb", gid.source),
+          step = ifelse(i, 8L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 14 & gid.lb == 6 & sid.target == 41,
+          gid = ifelse(i, gid.ln, gid),
+          gid.source = ifelse(i, "gid.ln=14, gid.lb=6, sid.target = 41   -> gid.ln", gid.source),
+          step = ifelse(i, 9L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 7 & gid.lb == 6,
+          gid = ifelse(i, gid.ln, gid),
+          gid.source = ifelse(i, "gid.ln=7, gid.lb=6   -> gid.ln", gid.source),
+          step = ifelse(i, 10L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 9 & gid.lb == 6,
+          gid = ifelse(i, gid.ln, gid),
+          gid.source = ifelse(i, "gid.ln=9, gid.lb=6   -> gid.ln", gid.source),
+          step = ifelse(i, 11L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 18 & gid.lb == 38,
+          gid = ifelse(i, gid.ln, gid),
+          gid.source = ifelse(i, "gid.ln=18, gid.lb=38   -> gid.ln", gid.source),
+          step = ifelse(i, 12L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 6 & gid.lb == 14,
+          gid = ifelse(i, gid.lb, gid),
+          gid.source = ifelse(i, "gid.ln=6, gid.lb=14   -> gid.lb", gid.source),
+          step = ifelse(i, 13L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 15 & gid.lb == 39,
+          gid = ifelse(i, gid.lb, gid),
+          gid.source = ifelse(i, "gid.ln=15, gid.lb=39   -> gid.lb", gid.source),
+          step  = ifelse(i, 14L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 40 & gid.lb %in% c(5, 6),
+          gid = ifelse(i, gid.ln, gid),
+          gid.source = ifelse(i, "gid.ln=40, gid.lb=5,6   -> gid.ln", gid.source),
+          step = ifelse(i, 15L, step)) %>% 
+   mutate(i = is.na(gid) & is.na(gid.ln) & gid.lb %in% c(1:3),
+          gid = ifelse(i, gid.lb, gid),
+          gid.source = ifelse(i, "is.na(gid.ln), gid.lb=1:3   -> gid.lb", gid.source),
+          step = ifelse(i, 16L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 21 & gid.lb == 6,
+          gid = ifelse(i, 7, gid),
+          gid.source = ifelse(i, "gid.ln=21, gid.lb=6   -> 7", gid.source),
+          step = ifelse(i, 17L, step)) %>% 
+   mutate(i = is.na(gid) & gid.ln == 21 & gid.lb == 14,
+          gid = ifelse(i, gid.lb, gid),
+          gid.source = ifelse(i, "gid.ln=21, gid.lb=14   -> gid.lb", gid.source),
+          step = ifelse(i, 18L, step))
> 
> 
> paste("Number of records:", nrow(LGS))
[1] "Number of records: 1725385"
> LGS %>% 
+   count(step, gid, gid.lb, gid.ln, gid.source) %>% 
+   mutate(p = round(n / sum(n) * 100, 3)) %>% 
+   arrange(-n) %>% 
+   knitr::kable(caption = "Overview of gear corrections")


Table: Overview of gear corrections

| step| gid| gid.lb| gid.ln|gid.source                                               |      n|      p|
|----:|---:|------:|------:|:--------------------------------------------------------|------:|------:|
|    1|   6|      6|      6|gid.lb=gid.ln                                            | 611619| 35.448|
|    1|   3|      3|      3|gid.lb=gid.ln                                            | 287210| 16.646|
|    1|   5|      5|      5|gid.lb=gid.ln                                            | 263923| 15.296|
|    1|   1|      1|      1|gid.lb=gid.ln                                            | 213727| 12.387|
|    1|   2|      2|      2|gid.lb=gid.ln                                            |  70050|  4.060|
|    1|  14|     14|     14|gid.lb=gid.ln                                            |  57342|  3.323|
|    2|   7|      7|     21|gc.lb=gc.ln   -> gid.lb                                  |  52125|  3.021|
|    1|   9|      9|      9|gid.lb=gid.ln                                            |  47948|  2.779|
|    2|   2|      2|     25|gc.lb=gc.ln   -> gid.lb                                  |  19181|  1.112|
|    2|  15|     38|     15|gc.lb=gc.ln   -> gid.lb                                  |  15156|  0.878|
|    3|  15|      6|     15|gid.ln=15, gid.lb=5,6   -> gid.ln                        |  10829|  0.628|
|    2|   2|      2|     91|gc.lb=gc.ln   -> gid.lb                                  |   9373|  0.543|
|    1|  15|     15|     15|gid.lb=gid.ln                                            |   9348|  0.542|
|    1|  12|     12|     12|gid.lb=gid.ln                                            |   7335|  0.425|
|    2|   2|      2|     92|gc.lb=gc.ln   -> gid.lb                                  |   5716|  0.331|
|    1|   7|      7|      7|gid.lb=gid.ln                                            |   4852|  0.281|
|    3|  15|      5|     15|gid.ln=15, gid.lb=5,6   -> gid.ln                        |   4442|  0.257|
|    1|  25|     25|     25|gid.lb=gid.ln                                            |   3565|  0.207|
|    2|   7|      7|     13|gc.lb=gc.ln   -> gid.lb                                  |   3001|  0.174|
|   15|  40|      6|     40|gid.ln=40, gid.lb=5,6   -> gid.ln                        |   2863|  0.166|
|    2|  15|     40|     15|gc.lb=gc.ln   -> gid.lb                                  |   2081|  0.121|
|    1|  40|     40|     40|gid.lb=gid.ln                                            |   2001|  0.116|
|    2|   6|      6|     14|gc.lb=gc.ln   -> gid.lb                                  |   1732|  0.100|
|    2|   4|     10|     12|gc.lb=gc.ln   -> gid.lb                                  |   1363|  0.079|
|    4|   6|      6|     21|gid.ln=21, gid.lb=6, sid.target != 30,36,41   -> gid.lb  |   1294|  0.075|
|    2|  17|     39|     18|gc.lb=gc.ln   -> gid.lb                                  |   1218|  0.071|
|    7|  18|      5|     18|gid.ln=18, gid.lb=5   -> gid.ln                          |   1184|  0.069|
|    6|   7|      7|      6|gid.ln=6, gid.lb=7, sid.target = 11,19,30:36   -> gid.lb |   1105|  0.064|
|   12|  18|     38|     18|gid.ln=18, gid.lb=38   -> gid.ln                         |    903|  0.052|
|    2|  15|     38|     40|gc.lb=gc.ln   -> gid.lb                                  |    901|  0.052|
|    1|  10|     10|     10|gid.lb=gid.ln                                            |    820|  0.048|
|   NA|  NA|      3|      1|NA                                                       |    782|  0.045|
|   NA|  NA|      1|      3|NA                                                       |    738|  0.043|
|   NA|  NA|      2|     18|NA                                                       |    719|  0.042|
|   10|   7|      6|      7|gid.ln=7, gid.lb=6   -> gid.ln                           |    718|  0.042|
|    2|   6|     14|      6|gc.lb=gc.ln   -> gid.lb                                  |    703|  0.041|
|    2|   6|      6|      9|gc.lb=gc.ln   -> gid.lb                                  |    605|  0.035|
|    2|   2|      2|     29|gc.lb=gc.ln   -> gid.lb                                  |    500|  0.029|
|   NA|  NA|     99|      1|NA                                                       |    430|  0.025|
|    2|   6|      9|      6|gc.lb=gc.ln   -> gid.lb                                  |    328|  0.019|
|    1|  92|     92|     92|gid.lb=gid.ln                                            |    309|  0.018|
|   NA|  NA|      7|     12|NA                                                       |    304|  0.018|
|   16|   3|      3|     NA|is.na(gid.ln), gid.lb=1:3   -> gid.lb                    |    280|  0.016|
|   NA|  NA|      7|      6|NA                                                       |    229|  0.013|
|   15|  40|      5|     40|gid.ln=40, gid.lb=5,6   -> gid.ln                        |    228|  0.013|
|   NA|  NA|      2|     40|NA                                                       |    211|  0.012|
|   17|   7|      6|     21|gid.ln=21, gid.lb=6   -> 7                               |    193|  0.011|
|   NA|  NA|      2|      3|NA                                                       |    181|  0.010|
|   NA|  NA|      3|     25|NA                                                       |    171|  0.010|
|   NA|  NA|      2|     15|NA                                                       |    164|  0.010|
|   NA|  NA|      5|      2|NA                                                       |    161|  0.009|
|    2|  17|     18|     17|gc.lb=gc.ln   -> gid.lb                                  |    152|  0.009|
|   NA|  NA|     12|     13|NA                                                       |    148|  0.009|
|   NA|  NA|     92|     18|NA                                                       |    147|  0.009|
|   NA|  NA|     91|     18|NA                                                       |    143|  0.008|
|   NA|  NA|      6|      5|NA                                                       |    133|  0.008|
|    8|  40|     40|     18|gid.ln=18, gid.lb=40   -> gid.lb                         |    113|  0.007|
|   NA|  NA|      2|      5|NA                                                       |    113|  0.007|
|   NA|  NA|      7|     10|NA                                                       |    112|  0.006|
|   NA|  NA|      5|      3|NA                                                       |    111|  0.006|
|    2|  17|     39|     17|gc.lb=gc.ln   -> gid.lb                                  |    110|  0.006|
|   NA|  NA|      5|      6|NA                                                       |    110|  0.006|
|    1|  91|     91|     91|gid.lb=gid.ln                                            |    101|  0.006|
|   NA|  NA|      2|      1|NA                                                       |     86|  0.005|
|   NA|  NA|     15|     41|NA                                                       |     84|  0.005|
|    2|   4|     12|     10|gc.lb=gc.ln   -> gid.lb                                  |     83|  0.005|
|   NA|  NA|      6|      1|NA                                                       |     77|  0.004|
|    1|  18|     18|     18|gid.lb=gid.ln                                            |     73|  0.004|
|   NA|  NA|     10|     21|NA                                                       |     71|  0.004|
|   NA|  NA|      1|     25|NA                                                       |     64|  0.004|
|   NA|  NA|      5|      1|NA                                                       |     57|  0.003|
|   NA|  NA|     92|      1|NA                                                       |     57|  0.003|
|   NA|  NA|      3|     15|NA                                                       |     55|  0.003|
|   NA|  NA|      9|     15|NA                                                       |     54|  0.003|
|   18|  14|     14|     21|gid.ln=21, gid.lb=14   -> gid.lb                         |     52|  0.003|
|    2|  15|     15|     40|gc.lb=gc.ln   -> gid.lb                                  |     51|  0.003|
|   NA|  NA|     38|     17|NA                                                       |     50|  0.003|
|   NA|  NA|      5|     14|NA                                                       |     48|  0.003|
|   NA|  NA|      3|      2|NA                                                       |     44|  0.003|
|   NA|  NA|      1|     18|NA                                                       |     42|  0.002|
|   NA|  NA|      6|      3|NA                                                       |     42|  0.002|
|   NA|  NA|     51|     17|NA                                                       |     37|  0.002|
|   NA|  NA|      5|      9|NA                                                       |     32|  0.002|
|   16|   1|      1|     NA|is.na(gid.ln), gid.lb=1:3   -> gid.lb                    |     28|  0.002|
|   NA|  NA|      3|     45|NA                                                       |     25|  0.001|
|   14|  39|     39|     15|gid.ln=15, gid.lb=39   -> gid.lb                         |     23|  0.001|
|   NA|  NA|      3|      6|NA                                                       |     23|  0.001|
|   NA|  NA|     25|      3|NA                                                       |     23|  0.001|
|   NA|  NA|      6|      2|NA                                                       |     21|  0.001|
|   NA|  NA|      1|      2|NA                                                       |     20|  0.001|
|   NA|  NA|      1|      6|NA                                                       |     17|  0.001|
|   NA|  NA|     40|     17|NA                                                       |     17|  0.001|
|   NA|  NA|     15|     20|NA                                                       |     14|  0.001|
|   NA|  NA|      6|     20|NA                                                       |     13|  0.001|
|   NA|  NA|     25|     18|NA                                                       |     13|  0.001|
|    2|   2|     25|      2|gc.lb=gc.ln   -> gid.lb                                  |     12|  0.001|
|   NA|  NA|      2|     17|NA                                                       |     12|  0.001|
|   NA|  NA|     10|     13|NA                                                       |     12|  0.001|
|   NA|  NA|     25|     40|NA                                                       |     11|  0.001|
|   NA|  NA|     29|     40|NA                                                       |     10|  0.001|
|    2|   2|     91|      2|gc.lb=gc.ln   -> gid.lb                                  |      9|  0.001|
|   NA|  NA|      6|     25|NA                                                       |      9|  0.001|
|   NA|  NA|     29|     18|NA                                                       |      9|  0.001|
|   NA|  NA|     38|      3|NA                                                       |      9|  0.001|
|   NA|  NA|     38|     25|NA                                                       |      9|  0.001|
|   16|   2|      2|     NA|is.na(gid.ln), gid.lb=1:3   -> gid.lb                    |      8|  0.000|
|   NA|  NA|      2|      6|NA                                                       |      8|  0.000|
|   NA|  NA|      5|     17|NA                                                       |      8|  0.000|
|   NA|  NA|     14|      5|NA                                                       |      8|  0.000|
|   NA|  NA|      3|      5|NA                                                       |      7|  0.000|
|   NA|  NA|      3|     14|NA                                                       |      7|  0.000|
|   NA|  NA|      3|     20|NA                                                       |      7|  0.000|
|   NA|  NA|      9|      7|NA                                                       |      7|  0.000|
|   NA|  NA|     11|     40|NA                                                       |      7|  0.000|
|   NA|  NA|     25|     NA|NA                                                       |      7|  0.000|
|   NA|  NA|      1|     17|NA                                                       |      6|  0.000|
|   NA|  NA|      1|     45|NA                                                       |      6|  0.000|
|   NA|  NA|      5|     10|NA                                                       |      6|  0.000|
|   NA|  NA|      7|     14|NA                                                       |      6|  0.000|
|   NA|  NA|      9|      1|NA                                                       |      6|  0.000|
|   NA|  NA|     25|     17|NA                                                       |      6|  0.000|
|   NA|  NA|     39|     40|NA                                                       |      6|  0.000|
|   NA|  NA|     51|     18|NA                                                       |      6|  0.000|
|   NA|  NA|      1|     20|NA                                                       |      5|  0.000|
|   NA|  NA|     11|     18|NA                                                       |      5|  0.000|
|   NA|  NA|     91|     NA|NA                                                       |      5|  0.000|
|   NA|  NA|      2|     45|NA                                                       |      4|  0.000|
|   NA|  NA|      3|     17|NA                                                       |      4|  0.000|
|   NA|  NA|      6|     12|NA                                                       |      4|  0.000|
|   NA|  NA|      6|     13|NA                                                       |      4|  0.000|
|   NA|  NA|      7|      3|NA                                                       |      4|  0.000|
|   NA|  NA|     18|     25|NA                                                       |      4|  0.000|
|   NA|  NA|     92|     40|NA                                                       |      4|  0.000|
|    2|   2|     25|     92|gc.lb=gc.ln   -> gid.lb                                  |      3|  0.000|
|   NA|  NA|      3|     29|NA                                                       |      3|  0.000|
|   NA|  NA|      3|     91|NA                                                       |      3|  0.000|
|   NA|  NA|      7|      1|NA                                                       |      3|  0.000|
|   NA|  NA|      7|      5|NA                                                       |      3|  0.000|
|   NA|  NA|      9|      2|NA                                                       |      3|  0.000|
|   NA|  NA|     14|      1|NA                                                       |      3|  0.000|
|   NA|  NA|     38|      2|NA                                                       |      3|  0.000|
|   NA|  NA|      6|     17|NA                                                       |      2|  0.000|
|   NA|  NA|      6|     18|NA                                                       |      2|  0.000|
|   NA|  NA|      9|      5|NA                                                       |      2|  0.000|
|   NA|  NA|     14|     40|NA                                                       |      2|  0.000|
|   NA|  NA|     29|     NA|NA                                                       |      2|  0.000|
|   NA|  NA|     39|      1|NA                                                       |      2|  0.000|
|   NA|  NA|     39|     25|NA                                                       |      2|  0.000|
|   NA|  NA|     39|     91|NA                                                       |      2|  0.000|
|   NA|  NA|     40|      2|NA                                                       |      2|  0.000|
|   NA|  NA|     40|     25|NA                                                       |      2|  0.000|
|    1|  29|     29|     29|gid.lb=gid.ln                                            |      1|  0.000|
|    2|   2|     11|      2|gc.lb=gc.ln   -> gid.lb                                  |      1|  0.000|
|    2|   2|     29|     25|gc.lb=gc.ln   -> gid.lb                                  |      1|  0.000|
|    2|   2|     91|     25|gc.lb=gc.ln   -> gid.lb                                  |      1|  0.000|
|    2|   7|      8|     21|gc.lb=gc.ln   -> gid.lb                                  |      1|  0.000|
|   NA|  NA|      1|      5|NA                                                       |      1|  0.000|
|   NA|  NA|      1|     14|NA                                                       |      1|  0.000|
|   NA|  NA|      3|      9|NA                                                       |      1|  0.000|
|   NA|  NA|      3|     21|NA                                                       |      1|  0.000|
|   NA|  NA|      5|     42|NA                                                       |      1|  0.000|
|   NA|  NA|     10|      7|NA                                                       |      1|  0.000|
|   NA|  NA|     10|     14|NA                                                       |      1|  0.000|
|   NA|  NA|     11|      1|NA                                                       |      1|  0.000|
|   NA|  NA|     12|      7|NA                                                       |      1|  0.000|
|   NA|  NA|     12|     21|NA                                                       |      1|  0.000|
|   NA|  NA|     15|      3|NA                                                       |      1|  0.000|
|   NA|  NA|     15|     18|NA                                                       |      1|  0.000|
|   NA|  NA|     15|     25|NA                                                       |      1|  0.000|
|   NA|  NA|     18|      3|NA                                                       |      1|  0.000|
|   NA|  NA|     25|      1|NA                                                       |      1|  0.000|
|   NA|  NA|     25|     21|NA                                                       |      1|  0.000|
|   NA|  NA|     40|      3|NA                                                       |      1|  0.000|
|   NA|  NA|     51|      3|NA                                                       |      1|  0.000|
|   NA|  NA|     91|     40|NA                                                       |      1|  0.000|
> LGS %>% 
+   mutate(missing = is.na(gid)) %>% 
+   count(missing) %>% 
+   mutate(p = n / sum(n) * 100) %>% 
+   knitr::kable(caption = "Number and percentage of missing gear")


Table: Number and percentage of missing gear

|missing |       n|          p|
|:-------|-------:|----------:|
|FALSE   | 1718894| 99.6237941|
|TRUE    |    6491|  0.3762059|
> # end: Gear corrections
> 
> 
> # 3. Lump some gears -----------------------------------------------------------
> LGS <-
+   LGS %>% 
+   mutate(gid = case_when(gid %in% c(10, 12) ~ 4,   # purse seines
+                          gid %in% c(18, 39) ~ 18,      # traps
+                          TRUE ~ gid)) %>% 
+   # make the rest a negative number
+   mutate(gid = ifelse(is.na(gid), -666, gid)) %>% 
+   # "skip" these also in downstream processing
+   mutate(gid = ifelse(gid %in% c(4, 12, 42), -666, gid)) %>% 
+   # lump dredges into one single gear
+   mutate(gid = ifelse(gid %in% c(15, 37, 38, 40), 15, gid))
> paste("Number of records:", nrow(LGS))
[1] "Number of records: 1725385"
> # end: Lump some gears
> 
> 
> # 4. Cap effort and end of action ----------------------------------------------
> # Guestimate median effort where effort is missing, not critical
> median.effort <- 
+   LGS %>% 
+   group_by(gid) %>% 
+   summarise(median = median(effort, na.rm = TRUE)) %>% 
+   drop_na()
> LGS <- 
+   LGS %>% 
+   left_join(median.effort, by = "gid") %>% 
+   mutate(effort = ifelse(!is.na(effort), effort, median)) %>% 
+   select(-median) %>% 
+   # cap effort hours
+   mutate(effort = case_when(effort > 12 & gid ==  6 ~ 12,
+                             effort > 24 & gid ==  7 ~ 24,
+                             effort > 15 & gid == 14 ~ 15,
+                             TRUE ~ effort)) %>% 
+   # Cap on the t2 so not overlapping with next setting
+   #    NOTE: Effort not adjusted accordingly
+   arrange(vid, t1) %>%
+   group_by(vid) %>%
+   mutate(overlap = if_else(t2 > lead(t1), TRUE, FALSE, NA),
+          t22 = if_else(overlap,
+                        lead(t1) - minutes(1), # need to subtract 1 minute but get the format right
+                        t2,
+                        as.POSIXct(NA)),
+          t22 = ymd_hms(format(as.POSIXct(t22, origin="1970-01-01", tz="UTC"))),
+          t2 = if_else(overlap & !is.na(t22), t22, t2, as.POSIXct(NA))) %>%
+   ungroup() %>% 
+   select(-t22) 
Warning message:
There were 3 warnings in `mutate()`.
The first warning was:
ℹ In argument: `t22 = ymd_hms(format(as.POSIXct(t22, origin = "1970-01-01", tz
  = "UTC")))`.
ℹ In group 705: `vid = 2673`.
Caused by warning:
!  1 failed to parse.
ℹ Run `dplyr::last_dplyr_warnings()` to see the 2 remaining warnings. 
> paste("Number of records:", nrow(LGS))
[1] "Number of records: 1725385"
> # end: 4. Cap effort and end of action
> 
> 
> # 5. Mesh size "corrections" ---------------------------------------------------
> # 2023-05-24: This is no longer used to generate metier 6
> 
> # end:5. Mesh size "corrections"
> 
> 
> # 6. Set gear width proxy ------------------------------------------------------
> LGS <- 
+   LGS %>% 
+   mutate(gear.width = case_when(gid %in% c(6L, 7L, 9L, 14L) ~ as.numeric(sweeps),
+                                 gid %in% c(15L, 38L, 40L) ~ as.numeric(plow_width),
+                                 TRUE ~ NA_real_)) %>% 
+   # cap gear width
+   mutate(gear.width = case_when(gid ==  6L & gear.width > 250 ~ 250,
+                                 gid ==  7L & gear.width > 250 ~ 250,
+                                 gid ==  9L & gear.width >  75 ~  75,
+                                 gid == 14L & gear.width >  55 ~  55,
+                                 TRUE ~ gear.width))
> gear.width <- 
+   LGS %>% 
+   filter(gid %in% c(6, 7, 9, 14, 15, 37, 38, 40)) %>% 
+   group_by(gid) %>% 
+   summarise(gear.width.median = median(gear.width, na.rm = TRUE),
+             .groups = "drop")
> # use median gear width by gear, if gear width is missing
> #   could also try to do this by vessels. time scale (year) may also matter here
> LGS <- 
+   LGS %>% 
+   left_join(gear.width,
+             by = "gid") %>% 
+   mutate(gear.width = ifelse(gid %in% c(6, 7, 9, 14, 15, 37, 38, 40) & is.na(gear.width),
+                              gear.width.median,
+                              gear.width)) %>% 
+   select(-gear.width.median)
> 
> # Put gear width of 5 as 500 - this is taken from thin air
> #   TODO: What gear width should be used
> LGS <- 
+   LGS %>% 
+   mutate(gear.width = ifelse(gid == 5, 500, gear.width))
> LGS %>% 
+   group_by(gid) %>% 
+   summarise(median = median(gear.width),
+             mean = mean(gear.width),
+             sd = sd(gear.width),
+             min = min(gear.width),
+             max = max(gear.width)) %>% 
+   knitr::kable(caption = "Statistics on gear width - check min values")


Table: Statistics on gear width - check min values

|  gid| median|       mean|         sd| min| max|
|----:|------:|----------:|----------:|---:|---:|
| -666|     NA|         NA|         NA|  NA|  NA|
|    1|     NA|         NA|         NA|  NA|  NA|
|    2|     NA|         NA|         NA|  NA|  NA|
|    3|     NA|         NA|         NA|  NA|  NA|
|    5|    500| 500.000000|  0.0000000| 500| 500|
|    6|    100| 103.158180| 40.4320205|   0| 250|
|    7|     80|  87.100345| 50.8838839|   0| 250|
|    9|     45|  44.978748|  5.5553034|   1|  75|
|   14|     28|  28.042199| 13.0855031|   1|  55|
|   15|      2|   2.018172|  0.1537457|   1|   3|
|   17|     NA|         NA|         NA|  NA|  NA|
|   18|     NA|         NA|         NA|  NA|  NA|
|   25|     NA|         NA|         NA|  NA|  NA|
|   29|     NA|         NA|         NA|  NA|  NA|
|   91|     NA|         NA|         NA|  NA|  NA|
|   92|     NA|         NA|         NA|  NA|  NA|
> paste("Number of records:", nrow(LGS))
[1] "Number of records: 1725385"
> 
> 
> # Get rid of intermediary variables
> LGS <- 
+   LGS %>% 
+   select(-c(gid.lb, gid.ln, gc.lb, gc.ln, sid.target, catch, p, n.sid, i,
+             overlap))
> 
> 
> # 7. gear class of corrected gid -----------------------------------------------
> LGS <- 
+   LGS %>% 
+   left_join(gears %>% select(gid, gclass),
+             by = "gid")
> paste("Number of records:", nrow(LGS))
[1] "Number of records: 1725385"
> 
> 
> # 8. Match vid with mobileid in stk --------------------------------------------
> 
> # 2023-05-19 - new approach, older approach below - set to FALSE
> #              This step is no longer necessary, trail by vid is already available
> #              in ~/stasi/gis/AIS_TRAIL
> #              Here just some summary statistics for printout
> mobile_vid <-
+   tbl_mar(con, "ops$einarhj.mobile_vid") |> 
+   mutate(t1 = to_date(t1, "YYYY:MM:DD"),
+          t2 = to_date(t2, "YYYY:MM:DD")) |> 
+   select(mid, vid, t1, t2, pings) |> 
+   collect(n = Inf)
> summary.lgs <-
+   LGS %>% 
+   group_by(vid) %>% 
+   summarise(n.lgs = n(),
+             n.gid = n_distinct(gid),
+             min.date = min(date),
+             max.date = max(date),
+             .groups = "drop") |> 
+   # can have multiple matches
+   left_join(mobile_vid)
Joining with `by = join_by(vid)`
Warning message:
In left_join(LGS %>% group_by(vid) %>% summarise(n.lgs = n(), n.gid = n_distinct(gid),  :
  Each row in `x` is expected to match at most 1 row in `y`.
ℹ Row 31 of `x` matches multiple rows.
ℹ If multiple matches are expected, set `multiple = "all"` to silence this
  warning.
> summary.lgs |> 
+   filter(is.na(mid)) |> 
+   knitr::kable(caption = "Vessels with no matching mobileid")


Table: Vessels with no matching mobileid

|  vid| n.lgs| n.gid|min.date   |max.date   | mid|t1 |t2 | pings|
|----:|-----:|-----:|:----------|:----------|---:|:--|:--|-----:|
|    1|     3|     2|2021-04-09 |2021-04-21 |  NA|NA |NA |    NA|
|    5|    16|     3|2021-09-13 |2022-01-17 |  NA|NA |NA |    NA|
|   44|     1|     1|2017-01-25 |2017-01-25 |  NA|NA |NA |    NA|
|  199|     1|     1|2022-07-22 |2022-07-22 |  NA|NA |NA |    NA|
|  640|     1|     1|2022-04-13 |2022-04-13 |  NA|NA |NA |    NA|
|  729|     1|     1|2022-04-23 |2022-04-23 |  NA|NA |NA |    NA|
|  762|     1|     1|2022-05-11 |2022-05-11 |  NA|NA |NA |    NA|
|  914|     3|     1|2022-06-16 |2022-06-30 |  NA|NA |NA |    NA|
| 1083|     7|     1|2011-07-12 |2011-07-24 |  NA|NA |NA |    NA|
| 1152|     1|     1|2022-06-27 |2022-06-27 |  NA|NA |NA |    NA|
| 1599|   105|     3|2011-04-21 |2015-07-14 |  NA|NA |NA |    NA|
| 1703|     1|     1|2022-05-12 |2022-05-12 |  NA|NA |NA |    NA|
| 1786|    15|     1|2012-11-05 |2012-11-29 |  NA|NA |NA |    NA|
| 1793|     7|     1|2009-08-04 |2009-08-12 |  NA|NA |NA |    NA|
| 1805|    10|     1|2013-04-02 |2013-04-14 |  NA|NA |NA |    NA|
| 1845|     1|     1|2022-07-21 |2022-07-21 |  NA|NA |NA |    NA|
| 1860|     8|     1|2012-07-03 |2012-07-19 |  NA|NA |NA |    NA|
| 1908|     1|     1|2022-08-31 |2022-08-31 |  NA|NA |NA |    NA|
| 1934|     1|     1|2022-08-04 |2022-08-04 |  NA|NA |NA |    NA|
| 1936|    12|     1|2018-06-04 |2018-06-28 |  NA|NA |NA |    NA|
| 2031|     9|     1|2011-07-12 |2011-07-26 |  NA|NA |NA |    NA|
| 2107|     1|     1|2022-06-28 |2022-06-28 |  NA|NA |NA |    NA|
| 2123|     3|     1|2009-04-27 |2009-04-30 |  NA|NA |NA |    NA|
| 2127|     1|     1|2022-07-19 |2022-07-19 |  NA|NA |NA |    NA|
| 2191|     1|     1|2011-12-28 |2011-12-28 |  NA|NA |NA |    NA|
| 2248|     1|     1|2022-06-20 |2022-06-20 |  NA|NA |NA |    NA|
| 2344|     5|     1|2019-04-01 |2019-04-29 |  NA|NA |NA |    NA|
| 2369|     1|     1|2022-06-09 |2022-06-09 |  NA|NA |NA |    NA|
| 2526|     1|     1|2022-05-09 |2022-05-09 |  NA|NA |NA |    NA|
| 2601|     1|     1|2022-06-15 |2022-06-15 |  NA|NA |NA |    NA|
| 2621|    53|     1|2020-07-30 |2022-07-21 |  NA|NA |NA |    NA|
| 2644|    11|     1|2009-04-04 |2009-04-30 |  NA|NA |NA |    NA|
| 2753|    33|     1|2013-08-07 |2014-08-30 |  NA|NA |NA |    NA|
| 3019|     1|     1|2022-07-04 |2022-07-04 |  NA|NA |NA |    NA|
| 4575|     1|     1|2022-06-30 |2022-06-30 |  NA|NA |NA |    NA|
| 5165|     1|     1|2022-06-14 |2022-06-14 |  NA|NA |NA |    NA|
| 5214|     4|     1|2020-04-29 |2020-05-03 |  NA|NA |NA |    NA|
| 5371|     7|     1|2014-06-02 |2014-06-12 |  NA|NA |NA |    NA|
| 5515|     1|     1|2022-07-20 |2022-07-20 |  NA|NA |NA |    NA|
| 5765|     8|     1|2022-06-07 |2022-07-12 |  NA|NA |NA |    NA|
| 5844|     3|     1|2015-08-06 |2015-08-11 |  NA|NA |NA |    NA|
| 6160|     9|     1|2014-07-01 |2014-07-17 |  NA|NA |NA |    NA|
| 6210|     3|     1|2022-05-30 |2022-07-14 |  NA|NA |NA |    NA|
| 6304|    14|     1|2009-08-04 |2009-08-27 |  NA|NA |NA |    NA|
| 6320|    10|     1|2009-08-04 |2020-05-13 |  NA|NA |NA |    NA|
| 6357|     2|     1|2022-05-01 |2022-06-16 |  NA|NA |NA |    NA|
| 6383|     5|     1|2012-06-04 |2012-06-13 |  NA|NA |NA |    NA|
| 6430|     1|     1|2022-05-25 |2022-05-25 |  NA|NA |NA |    NA|
| 6520|     1|     1|2022-05-31 |2022-05-31 |  NA|NA |NA |    NA|
| 6535|     1|     1|2013-09-19 |2013-09-19 |  NA|NA |NA |    NA|
| 6553|     1|     1|2017-02-14 |2017-02-14 |  NA|NA |NA |    NA|
| 6781|    12|     1|2011-06-01 |2011-07-12 |  NA|NA |NA |    NA|
| 6809|     9|     1|2010-06-01 |2010-07-12 |  NA|NA |NA |    NA|
| 6932|     5|     1|2011-07-13 |2011-07-25 |  NA|NA |NA |    NA|
| 6937|     7|     1|2020-06-02 |2020-06-18 |  NA|NA |NA |    NA|
| 6960|     1|     1|2022-06-07 |2022-06-07 |  NA|NA |NA |    NA|
| 6971|     1|     1|2022-05-19 |2022-05-19 |  NA|NA |NA |    NA|
| 7003|     5|     1|2020-03-13 |2020-03-28 |  NA|NA |NA |    NA|
| 7142|     5|     1|2012-08-01 |2012-08-09 |  NA|NA |NA |    NA|
| 7289|     2|     1|2022-05-16 |2022-06-20 |  NA|NA |NA |    NA|
| 7297|     1|     1|2022-12-05 |2022-12-05 |  NA|NA |NA |    NA|
| 7306|     7|     1|2011-07-08 |2011-07-26 |  NA|NA |NA |    NA|
| 7365|     1|     1|2020-05-06 |2020-05-06 |  NA|NA |NA |    NA|
| 7714|   281|     1|2012-05-31 |2022-07-21 |  NA|NA |NA |    NA|
| 8008|    84|     1|2018-06-18 |2022-04-19 |  NA|NA |NA |    NA|
| 9047|     7|     1|2011-07-04 |2011-07-12 |  NA|NA |NA |    NA|
| 9908|     9|     1|2018-04-05 |2018-05-08 |  NA|NA |NA |    NA|
| 9911|    10|     1|2016-05-09 |2016-06-04 |  NA|NA |NA |    NA|
| 9928|    15|     1|2016-05-11 |2019-06-24 |  NA|NA |NA |    NA|
| 9938|     9|     1|2016-05-16 |2016-06-04 |  NA|NA |NA |    NA|
> 
> 
> # 2023-05-19 - earlier years stuff
> if(FALSE) {
+   vid.stk <-
+     # 2022-04-18 change
+     # mar:::stk_mobile_icelandic(con, correct = TRUE, vidmatch = TRUE) %>% 
+     # 2023-05-10 change
+     tbl_mar(con, "ops$einarhj.mobile_vid") %>% 
+     filter(pings > 0) |> 
+     select(mid, vid, pings, t1, t2) |>  
+     collect(n = Inf)
+   # Create a summary overview of logbook and stk informations, not necessary
+   #  for the workflow
+   summary.lgs <-
+     LGS %>% 
+     group_by(vid) %>% 
+     summarise(n.lgs = n(),
+               n.gid = n_distinct(gid),
+               min.date = min(date),
+               max.date = max(date),
+               .groups = "drop")
+   MIDs <- 
+     summary.lgs %>% 
+     left_join(vid.stk, by = "vid") %>% 
+     pull(mid) %>% 
+     unique()
+   # unexpected
+   table(!is.na(MIDs))
+   MIDs <- MIDs[!is.na(MIDs)]
+   # can only have 1000 records in filter downstream
+   mids1 <- MIDs[1:1000]
+   mids2 <- MIDs[1001:length(MIDs)]
+   summary.stk <-
+     bind_rows(stk_trail(con) %>% 
+                 filter(mid %in% mids1,
+                        time >= to_date("2009-01-01", "YYYY:MM:DD"),
+                        time <  to_date("2022-12-31", "YYYY:MM:DD")) %>% 
+                 group_by(mid) %>% 
+                 summarise(n.stk = n(),
+                           min.time = min(time, na.rm = TRUE),
+                           max.time = max(time, na.rm = TRUE)) %>% 
+                 collect(n = Inf),
+               stk_trail(con) %>% 
+                 filter(mid %in% mids2,
+                        time >= to_date("2009-01-01", "YYYY:MM:DD"),
+                        time <  to_date("2022-12-31", "YYYY:MM:DD")) %>% 
+                 group_by(mid) %>% 
+                 summarise(n.stk = n(),
+                           min.time = min(time, na.rm = TRUE),
+                           max.time = max(time, na.rm = TRUE)) %>% 
+                 collect(n = Inf))
+   # NOTE: get here more records than in the logbooks summary because 
+   #       some vessels have multiple mid, and then some, ... 
+   print(c(nrow(summary.lgs), nrow(summary.stk)))
+   d <- 
+     summary.stk %>% 
+     left_join(vid.stk %>% 
+                 select(mid, vid), by = "mid") %>% 
+     full_join(summary.lgs, by = "vid") %>% 
+     group_by(vid) %>% 
+     mutate(n.mid = n()) %>% 
+     ungroup() %>% 
+     # 2021-08-23 changes
+     left_join(omar:::vid_registry(con, standardize = TRUE) %>% 
+                 select(vid, vessel) %>% 
+                 collect(n = Inf), by = "vid") %>% 
+     select(vid, mid, vessel, n.lgs, n.stk, n.mid, everything()) %>% 
+     arrange(vid)
+   d %>% 
+     filter(is.na(mid)) %>% 
+     select(vid, vessel, n.lgs, n.gid:max.date) %>% 
+     knitr::kable(caption = "Vessels with no matching mobileid")
+   d %>% 
+     filter(!is.na(mid),
+            n.lgs <= 10) %>% 
+     arrange(n.lgs, -n.stk) %>% 
+     knitr::kable(caption = "Vessels with low logbook records")
+   # NOTE: Not sure if this is needed:
+   d %>% write_rds("data/VID_MID.rds")
+   vidmid_lookup <- 
+     d %>% 
+     select(vid, mid)
+   # add mobileid as string to LGS, this could also have been archieved with nest
+   # 2022-04-18: Not sure why doing this
+   d2 <- 
+     d %>% 
+     select(vid, mid) %>% 
+     arrange(vid) %>% 
+     group_by(vid) %>% 
+     mutate(midnr = 1:n()) %>% 
+     spread(midnr, mid) %>% 
+     mutate(mids = case_when(#!is.na(`3`) ~ paste(`1`, `2`, `3`, sep = "-"),
+       !is.na(`2`) ~ paste(`1`, `2`, sep = "-"),
+       TRUE ~ as.character(`1`))) %>% 
+     select(vid, mids)
+   # NOTE: Should maybe put a flag here for no mid match
+   LGS <- 
+     LGS %>% 
+     left_join(d2)
+   paste("Number of records:", nrow(LGS))
+ }
> # end: 8. Match vid with mobileid in stk
> 
> 
> # 9. Add vessel information ----------------------------------------------------
> vessels <- 
+   omar::vessels_vessels(con) |> 
+   filter(!vid %in% c(0, 1, 3:5),
+          !is.na(vessel)) %>% 
+   arrange(vid) %>% 
+   collect(n = Inf) %>% 
+   filter(vid %in% unique(LGS$vid))
> 
> 
> 
> vessel.miss <- 
+   vessels %>% 
+   filter(is.na(engine_kw) | is.na(length)) %>% 
+   select(vid, vessel, length, engine_kw)
> vessel.miss |> 
+   knitr::kable(caption = "Skip sem eru ekki skráð með kw eða lengd\nspurning hvort eigi að sleppa")


Table: Skip sem eru ekki skráð með kw eða lengd
spurning hvort eigi að sleppa

|  vid|vessel                        | length| engine_kw|
|----:|:-----------------------------|------:|---------:|
|  640|Árni Magnús                   |     NA|        NA|
| 1597|Nóri                          |  30.00|        NA|
| 1934|Hafgolan                      |   9.00|        NA|
| 2272|Egla                          |   7.76|        NA|
| 2601|Perla 790                     |   8.33|        NA|
| 2956|Glófaxi                       |  10.20|        NA|
| 2978|Oddeyrin                      |  42.00|        NA|
| 2983|Börkur                        |  89.03|        NA|
| 2991|Jökull                        |  44.00|        NA|
| 2992|Baldvin Njálsson              |  66.16|        NA|
| 2995|Háey I                        |  13.83|        NA|
| 2997|Einar Guðnason                |  14.70|        NA|
| 2999|Hulda                         |  12.48|        NA|
| 3000|Álsey                         |  68.80|        NA|
| 3007|Indriði Kristins              |  12.47|        NA|
| 3010|Björn                         |  12.97|        NA|
| 3013|Sólborg                       |  75.90|        NA|
| 3015|Svanur                        |  67.40|        NA|
| 3016|Suðurey                       |  62.60|        NA|
| 3017|Kristrún                      |  48.82|        NA|
| 3019|Research                      |   9.58|        NA|
| 3030|Vestri                        |  39.95|        NA|
| 3035|Hoffell                       |  75.40|        NA|
| 4575|Jens Chr.svabo                |     NA|        NA|
| 5165|Svala                         |     NA|        66|
| 5765|Hrönn                         |     NA|        NA|
| 6210|Ásrún                         |     NA|        NA|
| 6304|Már                           |     NA|        15|
| 6320|Alda                          |     NA|        33|
| 6383|Grétar                        |     NA|        26|
| 6457|Heppinn                       |     NA|        22|
| 6535|Eyfell                        |     NA|        22|
| 6971|Farsæll                       |     NA|        93|
| 8008|Sveinbjörn Hjálmarsson kafari |     NA|        NA|
| 9908|Grímur Óskr                   |   5.00|        NA|
| 9911|Sæfari                        |   5.00|        NA|
| 9928|Óskráður                      |   5.00|        NA|
| 9938|Ármann                        |   5.00|        NA|
> hreidar <- 
+   readxl::read_excel("~/stasi/hreidar/data-raw/HREIDAR_Islensk_skip.xlsx") |> 
+   janitor::clean_names() |> 
+   select(year = ar, vid = skskr_nr, length = lengd_skrad,  kw) |> 
+   group_by(vid) |> 
+   filter(year == max(year)) |> 
+   ungroup() |> 
+   filter(vid %in% vessel.miss$vid)
There were 50 or more warnings (use warnings() to see the first 50)
> vessels <- 
+   vessels |> 
+   left_join(hreidar |> select(vid, kw)) |> 
+   mutate(engine_kw = ifelse(is.na(engine_kw) & !is.na(kw) & kw > 0,
+                             kw,
+                             engine_kw)) |> 
+   select(-kw) |> 
+   left_join(hreidar |> select(vid, length_hreidar = length)) |> 
+   mutate(length = ifelse(is.na(length) & !is.na(length_hreidar) & length_hreidar > 0,
+                          length_hreidar,
+                          length)) |> 
+   select(-length_hreidar)
Joining with `by = join_by(vid)`
Joining with `by = join_by(vid)`
> vessel.miss <- 
+   vessels %>% 
+   filter(is.na(engine_kw) | is.na(length)) %>% 
+   select(vid, vessel, length, engine_kw)
> vessel.miss |> 
+   knitr::kable(caption = "Skip sem eru ekki skráð með kw eða lengd\nspurning hvort eigi að sleppa")


Table: Skip sem eru ekki skráð með kw eða lengd
spurning hvort eigi að sleppa

|  vid|vessel                        | length| engine_kw|
|----:|:-----------------------------|------:|---------:|
| 1597|Nóri                          |  30.00|        NA|
| 2272|Egla                          |   7.76|        NA|
| 2601|Perla 790                     |   8.33|        NA|
| 3007|Indriði Kristins              |  12.47|        NA|
| 3010|Björn                         |  12.97|        NA|
| 3019|Research                      |   9.58|        NA|
| 3030|Vestri                        |  39.95|        NA|
| 3035|Hoffell                       |  75.40|        NA|
| 4575|Jens Chr.svabo                |     NA|        NA|
| 5165|Svala                         |     NA|        66|
| 5765|Hrönn                         |     NA|        NA|
| 6210|Ásrún                         |     NA|        NA|
| 6304|Már                           |     NA|        15|
| 6535|Eyfell                        |     NA|        22|
| 6971|Farsæll                       |     NA|        93|
| 8008|Sveinbjörn Hjálmarsson kafari |     NA|        NA|
| 9908|Grímur Óskr                   |   5.00|        NA|
| 9911|Sæfari                        |   5.00|        NA|
| 9928|Óskráður                      |   5.00|        NA|
| 9938|Ármann                        |   5.00|        NA|
> vessels <- 
+   vessels |> 
+   mutate(engine_kw = case_when(vid == 3035 & is.na(engine_kw) ~ 5000,
+                                vid == 3030 & is.na(engine_kw) ~ 1000,
+                                .default = engine_kw)) |> 
+   mutate(engine_kw = ifelse(is.na(engine_kw), 10, engine_kw),
+          length = ifelse(is.na(length), 10, length))
> vessels %>% 
+   filter(is.na(engine_kw) | is.na(length)) %>% 
+   select(vid, vessel, length, engine_kw)
# A tibble: 0 × 4
# ℹ 4 variables: vid <dbl>, vessel <chr>, length <dbl>, engine_kw <dbl>
> 
> 
> LGS <- 
+   LGS %>% 
+   left_join(vessels %>% 
+               select(vid, kw = engine_kw, length, length_class))
Joining with `by = join_by(vid)`
> paste("Number of records:", nrow(LGS))
[1] "Number of records: 1725385"
> 
> # 10. Add metier ---------------------------------------------------------------
> metier <-
+   tribble(
+     ~gid, ~m4, ~m5_comment, ~m5, ~m6,
+     1, "LLS", "Fish",      "DEF",  "LLS_DEF_0_0_0",         # Long line
+     2, "GNS", "Fish",      "DEF",  "GNS_DEF_>=16_0_0",      # Gill net
+     3, "LHM", "Fish",      "DEF",  "LHM_DEF_0_0_0",         # Jiggers (hooks)
+     4, "PS",  "Fish",      "SPF",  NA,                      # "Cod" seine
+     5, "SDN", "Fish",      "DEF",  "SDN_DEF_>=120_0_0",     # Scottish seine
+     6, "OTB", "Fish",      "DEF",  "OTB_DEF_>=120_0_0",     # Bottom fish trawl
+     7, "OTM", "Fish",      "SPF",  "OTM_SPF_40-54_0_0",     # Pelagic trawl
+     9, "OTB", "Nephrops",  "MCD",  "OTB_MCD_70-89_0_0",     # Bottom nephrops trawl
+     10, "PS",  "Fish",      "SPF",  NA,                      # "Herring" seine
+     12, "PS",  "Fish",      "SPF",  NA,                      # "Capelin" seine
+     14, "OTB", "Shrimp",    "MCD",  "OTB_MCD_40-54_0_0",     # Bottom shrimp trawl
+     15, "DRB", "Misc",      "MOL",  "DRB_MOL_>0_0_0",        # Mollusc (scallop) dredge
+     17, "FPO", "Misc",      "DEF",  "FPO_DEF_>0_0_0",        # Traps
+     18, "FPO", "Misc",      "DEF",  "FPO_DEF_>0_0_0",        # Crab trap
+     25, "GNS", "Fish",      "DEF",  "GNS_DEF_>=16_0_0",      # Lumpsucker (female) net
+     38, "DRB", "Mollusc",   "MOL",  "DRB_MOL_>0_0_0",        # Mollusc	(cyprine) dredge
+     39, "TRP", "Mollusc",   "MOL",  NA,                      # Buccinum trap
+     40, "DRB", "Echinoderm","MOL",  "DRB_MOL_>0_0_0",        # Sea-urchins dredge
+     91, "GNS", "Fish",      "DEF",  "GNS_DEF_>=16_0_0",      # Monkfish net
+     92, "GNS", "Fish",      "DEF",  "GNS_DEF_>=16_0_0")      # Greenland halibut net
> 
> # metiers check if in vocabulary
> LGS <-
+   LGS %>% 
+   left_join(metier |> select(gid, m4, m5, m6)) |> 
+   mutate(type = "LE",
+          country = "ICE")
Joining with `by = join_by(gid)`
> 
> 
> LGS |> 
+   count(gid, m4, m5, m6) |> 
+   mutate(m4.valid = m4 %in% metier4$key,
+          m5.valdid = m5 %in% metier5$key,
+          m6.valid = m6 %in% metier6$key) |> 
+   knitr::kable(caption = "Metiers used and check if in vocabulary")


Table: Metiers used and check if in vocabulary

|  gid|m4  |m5  |m6                |      n|m4.valid |m5.valdid |m6.valid |
|----:|:---|:---|:-----------------|------:|:--------|:---------|:--------|
| -666|NA  |NA  |NA                |  16092|FALSE    |FALSE     |FALSE    |
|    1|LLS |DEF |LLS_DEF_0_0_0     | 213755|TRUE     |TRUE      |TRUE     |
|    2|GNS |DEF |GNS_DEF_>=16_0_0  | 104855|TRUE     |TRUE      |TRUE     |
|    3|LHM |DEF |LHM_DEF_0_0_0     | 287490|TRUE     |TRUE      |TRUE     |
|    5|SDN |DEF |SDN_DEF_>=120_0_0 | 263923|TRUE     |TRUE      |TRUE     |
|    6|OTB |DEF |OTB_DEF_>=120_0_0 | 616281|TRUE     |TRUE      |TRUE     |
|    7|OTM |SPF |OTM_SPF_40-54_0_0 |  61995|TRUE     |TRUE      |TRUE     |
|    9|OTB |MCD |OTB_MCD_70-89_0_0 |  47948|TRUE     |TRUE      |TRUE     |
|   14|OTB |MCD |OTB_MCD_40-54_0_0 |  57394|TRUE     |TRUE      |TRUE     |
|   15|DRB |MOL |DRB_MOL_>0_0_0    |  48013|TRUE     |TRUE      |TRUE     |
|   17|FPO |DEF |FPO_DEF_>0_0_0    |   1480|TRUE     |TRUE      |TRUE     |
|   18|FPO |DEF |FPO_DEF_>0_0_0    |   2183|TRUE     |TRUE      |TRUE     |
|   25|GNS |DEF |GNS_DEF_>=16_0_0  |   3565|TRUE     |TRUE      |TRUE     |
|   29|NA  |NA  |NA                |      1|FALSE    |FALSE     |FALSE    |
|   91|GNS |DEF |GNS_DEF_>=16_0_0  |    101|TRUE     |TRUE      |TRUE     |
|   92|GNS |DEF |GNS_DEF_>=16_0_0  |    309|TRUE     |TRUE      |TRUE     |
> 
> paste("Number of records:", nrow(LGS))
[1] "Number of records: 1725385"
> 
> 
> # 11. add ICES rectangles ------------------------------------------------------
> res <- data.frame(SI_LONG = LGS$lon,
+                   SI_LATI = LGS$lat)
> LGS <- 
+   LGS %>% 
+   mutate(ices = vmstools::ICESrectangle(res)) %>% 
+   mutate(valid.ices = !is.na(vmstools::ICESrectangle2LonLat(ices)$SI_LONG))
Warning message:
There was 1 warning in `mutate()`.
ℹ In argument: `valid.ices =
  !is.na(vmstools::ICESrectangle2LonLat(ices)$SI_LONG)`.
Caused by warning in `vmstools::ICESrectangle2LonLat()`:
! Some stat squares are not valid. Please check the help files for ICESrectangle2LonLat() for more information about the formal definition of valid ICES rectangles. 
> LGS %>% 
+   count(valid.ices) %>% 
+   knitr::kable(caption = "Valid ICES rectangles")


Table: Valid ICES rectangles

|valid.ices |       n|
|:----------|-------:|
|FALSE      |    2225|
|TRUE       | 1723160|
> paste("Number of records:", nrow(LGS))
[1] "Number of records: 1725385"
> 
> 
> # 12. Anonymize vid ------------------------------------------------------------
> #     May want to do this more downstream
> anonymize.vid <-
+   LGS %>%
+   select(vid) %>%
+   distinct() %>%
+   mutate(vid0 = 1:n(),
+          vid0 = paste0("ICE", str_pad(vid0, 4, pad = "0")))
> LGS <- 
+   LGS %>% 
+   left_join(anonymize.vid, by = "vid")
> paste("Number of records:", nrow(LGS))
[1] "Number of records: 1725385"
> 
> 
> 
> # 13. Determine what records to filter downstream ------------------------------
> # 
> LGS22 <- LGS
> LGS <- 
+   LGS %>% 
+   mutate(i = !gid %in% c(-666, 17, 18, 29),
+          use = ifelse(i, TRUE, FALSE),
+          use.not = ifelse(i, NA_character_, "drop gear")) %>% 
+   mutate(i = gid %in% c(6, 7, 9, 14) & (is.na(t1) | is.na(t2)),
+          use = ifelse(i, FALSE, use),
+          use.not = ifelse(i, "t1 or t2 missing", use.not)) %>% 
+   group_by(vid) %>% 
+   mutate(n.records = n()) %>% 
+   ungroup() %>% 
+   mutate(i = n.records <= 5,
+          use = ifelse(i, FALSE, use),
+          use.not = ifelse(i, "lb vid records <= 5", use.not)) %>% 
+   mutate(i = is.na(kw) | is.na(length),
+          use = ifelse(i, FALSE, use),
+          use.not = ifelse(i, "vid w. no kw or length", use.not)) %>% 
+   select(-n.records)
> LGS %>% 
+   count(use, gid, use.not) %>% 
+   knitr::kable(caption = "Records that retained (FALSE are dropped)")


Table: Records that retained (FALSE are dropped)

|use   |  gid|use.not                |      n|
|:-----|----:|:----------------------|------:|
|FALSE | -666|drop gear              |  16076|
|FALSE | -666|lb vid records <= 5    |      3|
|FALSE | -666|vid w. no kw or length |     13|
|FALSE |    1|lb vid records <= 5    |     11|
|FALSE |    2|lb vid records <= 5    |      6|
|FALSE |    2|vid w. no kw or length |      3|
|FALSE |    3|lb vid records <= 5    |    147|
|FALSE |    3|vid w. no kw or length |      5|
|FALSE |    6|t1 or t2 missing       |   1166|
|FALSE |    7|t1 or t2 missing       |    140|
|FALSE |    9|t1 or t2 missing       |      6|
|FALSE |   14|t1 or t2 missing       |     11|
|FALSE |   17|drop gear              |   1478|
|FALSE |   17|lb vid records <= 5    |      2|
|FALSE |   18|drop gear              |   2183|
|FALSE |   29|drop gear              |      1|
|TRUE  |    1|NA                     | 213744|
|TRUE  |    2|NA                     | 104846|
|TRUE  |    3|NA                     | 287338|
|TRUE  |    5|NA                     | 263923|
|TRUE  |    6|NA                     | 615115|
|TRUE  |    7|NA                     |  61855|
|TRUE  |    9|NA                     |  47942|
|TRUE  |   14|NA                     |  57383|
|TRUE  |   15|NA                     |  48013|
|TRUE  |   25|NA                     |   3565|
|TRUE  |   91|NA                     |    101|
|TRUE  |   92|NA                     |    309|
> LGS %>% 
+   count(use) %>% 
+   mutate(p = round(n / sum(n) * 100, 3)) %>% 
+   knitr::kable(caption = "Proportion of records")


Table: Proportion of records

|use   |       n|      p|
|:-----|-------:|------:|
|FALSE |   21251|  1.232|
|TRUE  | 1704134| 98.768|
> # LGS %>% 
> #   mutate(no.mid = ifelse(is.na(mids), TRUE, FALSE)) %>% 
> #   count(no.mid) %>% 
> #   mutate(p = round(n / sum(n) * 100, 3)) %>% 
> #   knitr::kable(caption = "Records with no mid, will be lost in the ais/vms processing")
> # end: XX. Determine what records to filter in later down streaming
> 
> 
> # 14. Save raw (no records filtered) file --------------------------------------
> #     Should be as downstream as possible
> LGS %>% write_rds("data/LGS_corrected.rds")
> 
> 
> # 15. FILTER OUT RECORDS -------------------------------------------------------
> #   NOTE: Need to think about non-valid ices rectangles
> #         The issue is that it may be invalid in the lgs but valid in the ais
> LGS %>% 
+   count(use, use.not, valid.ices) %>% 
+   mutate(p = round(n / sum(n) * 100, 3))
# A tibble: 9 × 5
  use   use.not                valid.ices       n      p
  <lgl> <chr>                  <lgl>        <int>  <dbl>
1 FALSE drop gear              FALSE          111  0.006
2 FALSE drop gear              TRUE         19627  1.14 
3 FALSE lb vid records <= 5    FALSE            4  0    
4 FALSE lb vid records <= 5    TRUE           165  0.01 
5 FALSE t1 or t2 missing       FALSE            1  0    
6 FALSE t1 or t2 missing       TRUE          1322  0.077
7 FALSE vid w. no kw or length TRUE            21  0.001
8 TRUE  <NA>                   FALSE         2109  0.122
9 TRUE  <NA>                   TRUE       1702025 98.6  
> LGS <- 
+   LGS %>% 
+   filter(use, valid.ices) %>% 
+   select(-c(use, use.not, valid.ices))
> # end: FILTER OUT RECORDS
> 
> 
> # 16. Collapse all gear but 6, 7, 9, 14 to daily records -----------------------
> lgs1 <-
+   LGS %>%
+   filter(gid %in% c(6, 7, 9, 14))
> #  For gear class not 6, 7, 9, 14 summarise the catch for the day
> #  and generate a new visir and set t1 and t2 as start and end time of the day
> #  The visir used is the lowest visir within a day
> lgs2 <-
+   LGS %>%
+   filter(!gid %in% c(6, 7, 9, 14))
> nrow(lgs1) + nrow(lgs2) == nrow(LGS)
[1] TRUE
> # generate a visir-visir lookup within the day
> #     the statistics will be summarised by visir.min (to be renamed visir
> #     downstream .
> visir_visir_lookup <- 
+   lgs2 %>% 
+   group_by(vid, date, gid) %>% 
+   mutate(visir.min = min(visir),
+          n.set = n()) %>% 
+   ungroup() %>% 
+   select(visir.min, visir, n.set)
> # there are some large number of records occurring within a single day
> #   check if this make sense, but at least expected for dredge per example
> #   below.
> visir_visir_lookup %>% count(n.set) %>% arrange(-n.set)
# A tibble: 34 × 2
   n.set     n
   <int> <int>
 1    39    39
 2    34    34
 3    33    99
 4    32    32
 5    30    30
 6    29    87
 7    28   336
 8    27   189
 9    26   104
10    25   275
# ℹ 24 more rows
> visir_visir_lookup %>% 
+   arrange(-n.set) %>% 
+   filter(visir.min %in% -1204185) %>% 
+   left_join(LGS) %>% 
+   select(visir.min:vid, date, lon, lat, effort, effort_unit) %>% 
+   knitr::kable()
Joining with `by = join_by(visir)`


| visir.min| visir| n.set| vid|date | lon| lat| effort|effort_unit |
|---------:|-----:|-----:|---:|:----|---:|---:|------:|:-----------|
> # "median" ICES rectangle? 
> # Calculate the median lon and lat within a day and the new ices-rectangle.
> #    Note, by calculating median one may end up with an ices rectangle that is 
> #     solely on land.
> lgs2 <- 
+   lgs2 %>% 
+   group_by(vid, date) %>% 
+   mutate(lon.m = median(lon, na.rm = TRUE),
+          lat.m = median(lat, na.rm = TRUE)) %>% 
+   ungroup()
> nrow(lgs1) + nrow(lgs2) == nrow(LGS)
[1] TRUE
> # Recalculate ICES rectangle based on the median position
> res <- data.frame(SI_LONG = lgs2$lon.m,
+                   SI_LATI = lgs2$lat.m)
> 
> # 2023-05-19: Generates error --------------------------------------------------
> # lgs2 <- 
> #   lgs2 %>% 
> #   select(-c(ices)) %>% 
> #   mutate(ices = vmstools::ICESrectangle(res)) %>% 
> #   mutate(valid.ices = !is.na(vmstools::ICESrectangle2LonLat(ices)$SI_LONG))
> # 
> # lgs2 %>% 
> #   count(valid.ices)
> 
> nrow(lgs1) + nrow(lgs2) == nrow(LGS)
[1] TRUE
> # End: "median" ICES rectangle
> # Collapse daily records and then merge with daily records
> lgs2B <- 
+   lgs2 %>% 
+   mutate(year = year(date)) |> 
+   # group by all variables that are needed downstream and then some
+   group_by(vid, vid0, year, date, gid, ices, m4, m5, m6, length, length_class) %>%
+   # get here all essential variables that are needed downstream
+   summarise(visir = min(visir),
+             n.sets = n(),
+             effort = sum(effort, na.rm = TRUE),
+             total = sum(total, na.rm = TRUE),
+             kw = mean(kw, na.rm = TRUE),
+             gear.width = mean(gear.width, na.rm = TRUE),
+             .groups = "drop") %>%
+   mutate(t1 = ymd_hms(paste0(year(date), "-", month(date), "-", day(date),
+                              " 00:00:00")),
+          t2 = ymd_hms(paste0(year(date), "-", month(date), "-", day(date),
+                              " 23:59:00")))
> sum(lgs2B$effort)
[1] 3967338823
> sum(lgs2$effort)    # 2023-05-19 Have missing effort needs checks
[1] 3967338823
> # minor checks
> #   missing unit of effort, fix upstream - not really critical
> LGS %>% 
+   group_by(gid, effort_unit) %>% 
+   summarise(effort = sum(effort),
+             kw = mean(kw))
`summarise()` has grouped output by 'gid'. You can override using the `.groups`
argument.
# A tibble: 20 × 4
# Groups:   gid [12]
     gid effort_unit      effort    kw
   <dbl> <chr>             <dbl> <dbl>
 1     1 hooks       4055033494   397.
 2     1 <NA>          11008000   313.
 3     2 netnights     13017707.  377.
 4     2 <NA>             38160   200.
 5     3 hookhours   -112999325.  145.
 6     3 <NA>            513756   146.
 7     5 hours towed          5   459 
 8     5 setting         263554   432.
 9     5 <NA>               332   476.
10     6 hours towed    2365856. 1669.
11     7 hours towed     403579. 3826.
12     9 hours towed     237344.  598.
13    14 hours towed     448860.  840.
14    15 hours towed      43192.  387.
15    15 setting           4668   499.
16    25 netnights       132338.  170.
17    25 <NA>             94119.  163.
18    91 netnights         3103.  144 
19    91 <NA>              5603.  135.
20    92 netnights       180117. 1276.
> LGS %>% filter(is.na(effort_unit)) %>% pull(vid) %>% unique()
  [1] 1102 1136 1184 1304 1321 1343 1399 1416 1434 1489 1511 1523 1535 1540 1542
 [16] 1544 1560 1561 1563 1575 1582 1621 1637 1650 1695 1734 1737 1750 1762 1764
 [31] 1765 1769 1771 1774 1775 1776 1777 1787 1790 1792 1794 1796 1802 1827 1828
 [46] 1831 1834 1836 1841 1842 1844 1852 1856 1859 1876 1881 1882 1883 1887 1888
 [61] 1904 1906 1907 1909 1910 1911 1914 1918 1922 1924 1925 1926 1928 1932 1954
 [76] 1958 1971 1988 1992 2005 2010 2014 2045 2047 2050 2062 2064 2068 2069 2070
 [91] 2072 2076 2081 2086 2088 2090 2091 2098 2104 2110 2125 2126 2129 2134 2136
[106] 2147 2151 2159 2160 2161 2162 2174 2179 2183 2185 2189 2192 2195 2207 2238
[121] 2243 2256 2257 2264 2282 2307 2313 2314 2316 2319 2320 2331 2335 2339 2340
[136] 2342 2347 2356 2357 2358 2359 2360 2365 2368 2370 2373 2374 2383 2384 2385
[151] 2387 2389 2392 2394 2398 2399 2406 2408 2417 2418 2419 2421 2426 2431 2432
[166] 2434 2437 2438 2441 2443 2446 2447 2452 2457 2458 2461 2462 2477 2478 2491
[181] 2493 2494 2497 2499 2501 2502 2515 2519 2529 2532 2535 2538 2539 2540 2545
[196] 2555 2557 2558 2564 2567 2571 2575 2578 2580 2581 2585 2587 2588 2589 2590
[211] 2595 2596 2597 2612 2614 2615 2620 2621 2624 2625 2635 2655 2656 2657 2660
[226] 2666 2670 2671 2672 2678 2696 2704 2705 2706 2712 2716 2726 2755 2757 2760
[241] 2763 2771 2781 2782 2783 2786 2790 2794 2796 2799 2803 2805 2806 2809 2811
[256] 2813 2818 2819 2822 2823 2824 2825 2833 2834 2841 2842 2843 2847 2866 2869
[271] 2871 2911 2939 2940 2951 2956 2957 2959 2965 2969 2995 5183 5665 5713 5823
[286] 5889 5892 5894 5915 5920 5923 5930 5946 5967 5978 5982 5986 6002 6006 6008
[301] 6013 6021 6024 6035 6037 6044 6055 6070 6077 6083 6086 6089 6094 6106 6107
[316] 6110 6111 6121 6126 6130 6131 6136 6141 6143 6147 6150 6152 6158 6166 6175
[331] 6181 6182 6186 6190 6191 6194 6195 6204 6206 6209 6214 6218 6220 6225 6230
[346] 6236 6237 6242 6243 6244 6249 6252 6256 6261 6272 6283 6284 6293 6299 6301
[361] 6302 6305 6314 6322 6330 6337 6342 6345 6347 6350 6353 6360 6361 6366 6368
[376] 6369 6376 6377 6382 6386 6389 6390 6391 6395 6401 6403 6416 6417 6418 6420
[391] 6429 6443 6450 6462 6470 6473 6474 6484 6487 6488 6494 6499 6503 6504 6513
[406] 6517 6518 6523 6526 6529 6533 6540 6546 6548 6549 6552 6562 6563 6565 6569
[421] 6571 6575 6579 6582 6583 6584 6588 6589 6591 6595 6598 6600 6603 6607 6609
[436] 6610 6619 6620 6625 6626 6629 6632 6633 6639 6643 6644 6649 6652 6662 6669
[451] 6678 6684 6686 6688 6692 6702 6703 6711 6716 6719 6725 6726 6728 6737 6738
[466] 6743 6745 6754 6757 6762 6764 6765 6769 6770 6771 6776 6783 6784 6790 6792
[481] 6794 6795 6798 6804 6814 6816 6817 6821 6822 6826 6827 6830 6836 6837 6838
[496] 6847 6849 6852 6856 6857 6859 6863 6865 6868 6871 6874 6875 6877 6878 6880
[511] 6882 6883 6888 6890 6905 6917 6918 6919 6921 6931 6933 6934 6935 6936 6943
[526] 6945 6946 6947 6952 6957 6961 6978 6979 6982 6986 6987 6990 6991 6996 6998
[541] 6999 7000 7001 7007 7011 7019 7020 7023 7028 7031 7037 7038 7046 7051 7053
[556] 7055 7056 7057 7059 7062 7064 7066 7067 7072 7074 7075 7076 7081 7082 7084
[571] 7092 7095 7096 7097 7103 7104 7105 7111 7113 7116 7121 7124 7126 7127 7133
[586] 7136 7143 7147 7150 7152 7154 7156 7157 7160 7161 7162 7164 7168 7170 7172
[601] 7175 7176 7180 7185 7189 7190 7191 7194 7202 7206 7207 7211 7214 7219 7220
[616] 7221 7223 7226 7230 7233 7243 7246 7250 7253 7259 7261 7262 7263 7269 7272
[631] 7278 7281 7284 7287 7296 7298 7305 7309 7315 7317 7320 7321 7323 7325 7328
[646] 7329 7331 7332 7334 7335 7337 7338 7339 7344 7346 7347 7352 7354 7355 7357
[661] 7359 7361 7362 7363 7364 7366 7369 7377 7381 7382 7386 7388 7392 7393 7395
[676] 7398 7400 7401 7402 7410 7411 7412 7413 7414 7416 7417 7418 7419 7420 7423
[691] 7426 7427 7428 7429 7430 7432 7433 7437 7439 7445 7453 7455 7458 7459 7461
[706] 7463 7464 7466 7467 7472 7478 7479 7485 7486 7490 7495 7498 7514 7515 7518
[721] 7526 7527 7528 7531 7532 7533 7537 7538 7539 7545 7547 7611 7612 7641 7661
[736] 7664 7668 7670 7676 7680 7683 7685 7691 7694 7696 7697 7702 7703 7704 7709
[751] 7711 7716 7718 7720 7727 7729 7730 7737 7755 7757 7758 7762 7763 7768 7781
[766] 7787 7788 7789 7837 7838 7839 9037 9048
> LGS %>% 
+   filter(is.na(kw)) %>% 
+   count(vid)
# A tibble: 0 × 2
# ℹ 2 variables: vid <dbl>, n <int>
> LGS %>% 
+   filter(is.na(effort)) %>% 
+   count(gid)
# A tibble: 0 × 2
# ℹ 2 variables: gid <dbl>, n <int>
> # Merge stuff again, note some variables in lgs1 not in lgs2B
> LGS.collapsed <- 
+   bind_rows(lgs1, lgs2B) |> 
+   mutate(year = year(date))
> 
> LGS.collapsed %>% write_rds("data/logbooks.rds")
> 
> devtools::session_info()
─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.2.2 (2022-10-31)
 os       Debian GNU/Linux 11 (bullseye)
 system   x86_64, linux-gnu
 ui       X11
 language (EN)
 collate  is_IS.UTF-8
 ctype    is_IS.UTF-8
 tz       Atlantic/Reykjavik
 date     2023-05-29
 pandoc   2.9.2.1 @ /usr/bin/pandoc

─ Packages ───────────────────────────────────────────────────────────────────
 package        * version    date (UTC) lib source
 backports        1.4.1      2021-12-13 [1] CRAN (R 4.2.2)
 blob             1.2.4      2023-03-17 [1] CRAN (R 4.2.2)
 broom            1.0.4      2023-03-11 [1] CRAN (R 4.2.2)
 cachem           1.0.7      2023-02-24 [1] CRAN (R 4.2.2)
 callr            3.7.3      2022-11-02 [1] CRAN (R 4.2.2)
 cellranger       1.1.0      2016-07-27 [1] CRAN (R 4.2.2)
 cli              3.6.1      2023-03-23 [1] CRAN (R 4.2.2)
 cluster          2.1.4      2022-08-22 [3] CRAN (R 4.2.2)
 colorspace       2.1-0      2023-01-23 [1] CRAN (R 4.2.2)
 crayon           1.5.2      2022-09-29 [1] CRAN (R 4.2.2)
 curl             5.0.0      2023-01-12 [1] CRAN (R 4.2.2)
 data.table     * 1.14.8     2023-02-17 [1] CRAN (R 4.2.2)
 DBI              1.1.3      2022-06-18 [1] CRAN (R 4.2.2)
 dbplyr           2.3.2      2023-03-21 [1] CRAN (R 4.2.2)
 Deriv            4.1.3      2021-02-24 [1] CRAN (R 4.2.2)
 devtools         2.4.5      2022-10-11 [1] CRAN (R 4.2.2)
 digest           0.6.31     2022-12-11 [1] CRAN (R 4.2.2)
 doBy             4.6.16     2023-01-18 [1] CRAN (R 4.2.2)
 dplyr          * 1.1.0      2023-01-29 [1] CRAN (R 4.2.2)
 ellipsis         0.3.2      2021-04-29 [1] CRAN (R 4.2.2)
 fansi            1.0.4      2023-01-22 [1] CRAN (R 4.2.2)
 farver           2.1.1      2022-07-06 [1] CRAN (R 4.2.2)
 fastmap          1.1.1      2023-02-24 [1] CRAN (R 4.2.2)
 forcats        * 1.0.0      2023-01-29 [1] CRAN (R 4.2.2)
 foreign          0.8-83     2022-09-28 [3] CRAN (R 4.2.2)
 fs               1.6.2      2023-04-25 [1] CRAN (R 4.2.2)
 generics         0.1.3      2022-07-05 [1] CRAN (R 4.2.2)
 ggplot2        * 3.4.2      2023-04-03 [1] CRAN (R 4.2.2)
 glue             1.6.2      2022-02-24 [1] CRAN (R 4.2.2)
 gtable           0.3.3      2023-03-21 [1] CRAN (R 4.2.2)
 hms              1.1.3      2023-03-21 [1] CRAN (R 4.2.2)
 htmltools        0.5.5      2023-03-23 [1] CRAN (R 4.2.2)
 htmlwidgets      1.6.2      2023-03-17 [1] CRAN (R 4.2.2)
 httpuv           1.6.11     2023-05-11 [1] CRAN (R 4.2.2)
 httr             1.4.6      2023-05-08 [1] CRAN (R 4.2.2)
 icesVocab        1.2.0      2022-02-10 [1] CRAN (R 4.2.2)
 janitor          2.2.0      2023-02-02 [1] CRAN (R 4.2.2)
 jsonlite         1.8.4      2022-12-06 [1] CRAN (R 4.2.2)
 kernlab          0.9-32     2023-01-31 [1] CRAN (R 4.2.2)
 knitr            1.42       2023-01-25 [1] CRAN (R 4.2.2)
 labeling         0.4.2      2020-10-20 [1] CRAN (R 4.2.2)
 later            1.3.1      2023-05-02 [1] CRAN (R 4.2.2)
 lattice          0.20-45    2021-09-22 [3] CRAN (R 4.2.1)
 lazyeval         0.2.2      2019-03-15 [1] CRAN (R 4.2.2)
 lifecycle        1.0.3      2022-10-07 [1] CRAN (R 4.2.2)
 lubridate      * 1.9.2      2023-02-10 [1] CRAN (R 4.2.2)
 magrittr         2.0.3      2022-03-30 [1] CRAN (R 4.2.2)
 mapdata          2.3.1      2022-11-01 [1] CRAN (R 4.2.2)
 maps             3.4.1      2022-10-30 [1] CRAN (R 4.2.2)
 maptools         1.1-6      2022-12-14 [1] CRAN (R 4.2.2)
 mar              2022-03-25 2023-02-10 [1] xgit (https://gitlab.hafogvatn.is/dev/mar.git@f7cd721)
 MASS             7.3-58.1   2022-08-03 [3] CRAN (R 4.2.2)
 Matrix           1.4-1      2022-03-23 [3] CRAN (R 4.2.1)
 memoise          2.0.1      2021-11-26 [1] CRAN (R 4.2.2)
 microbenchmark   1.4.10     2023-04-28 [1] CRAN (R 4.2.2)
 mime             0.12       2021-09-28 [1] CRAN (R 4.2.2)
 miniUI           0.1.1.1    2018-05-18 [1] CRAN (R 4.2.2)
 mixtools         2.0.0      2022-12-05 [1] CRAN (R 4.2.2)
 munsell          0.5.0      2018-06-12 [1] CRAN (R 4.2.2)
 nlme             3.1-160    2022-10-10 [3] CRAN (R 4.2.2)
 omar           * 2023.05.25 2023-05-25 [1] local
 PBSmapping       2.73.2     2022-09-07 [1] CRAN (R 4.2.2)
 pillar           1.9.0      2023-03-22 [1] CRAN (R 4.2.2)
 pkgbuild         1.4.0      2022-11-27 [1] CRAN (R 4.2.2)
 pkgconfig        2.0.3      2019-09-22 [1] CRAN (R 4.2.2)
 pkgload          1.3.2      2022-11-16 [1] CRAN (R 4.2.2)
 plotly           4.10.1     2022-11-07 [1] CRAN (R 4.2.2)
 prettyunits      1.1.1      2020-01-24 [1] CRAN (R 4.2.2)
 processx         3.8.1      2023-04-18 [1] CRAN (R 4.2.2)
 profvis          0.3.8      2023-05-02 [1] CRAN (R 4.2.2)
 promises         1.2.0.1    2021-02-11 [1] CRAN (R 4.2.2)
 ps               1.7.5      2023-04-18 [1] CRAN (R 4.2.2)
 purrr          * 1.0.1      2023-01-10 [1] CRAN (R 4.2.2)
 R6               2.5.1      2021-08-19 [1] CRAN (R 4.2.2)
 RColorBrewer     1.1-3      2022-04-03 [1] CRAN (R 4.2.2)
 Rcpp             1.0.10     2023-01-22 [1] CRAN (R 4.2.2)
 readr          * 2.1.4      2023-02-10 [1] CRAN (R 4.2.2)
 readxl           1.4.2      2023-02-09 [1] CRAN (R 4.2.2)
 remotes          2.4.2      2021-11-30 [1] CRAN (R 4.2.2)
 rlang            1.1.1      2023-04-28 [1] CRAN (R 4.2.2)
 ROracle          1.3-1.1    2021-11-10 [2] CRAN (R 4.2.2)
 rstudioapi       0.14       2022-08-22 [1] CRAN (R 4.2.2)
 scales           1.2.1      2022-08-20 [1] CRAN (R 4.2.2)
 segmented        1.6-4      2023-04-13 [1] CRAN (R 4.2.2)
 sessioninfo      1.2.2      2021-12-06 [1] CRAN (R 4.2.2)
 shiny            1.7.4      2022-12-15 [1] CRAN (R 4.2.2)
 snakecase        0.11.0     2019-05-25 [1] CRAN (R 4.2.2)
 sp               1.6-0      2023-01-19 [1] CRAN (R 4.2.2)
 stringi          1.7.12     2023-01-11 [1] CRAN (R 4.2.2)
 stringr        * 1.5.0      2022-12-02 [1] CRAN (R 4.2.2)
 survival         3.4-0      2022-08-09 [3] CRAN (R 4.2.2)
 tibble         * 3.2.0      2023-03-08 [1] CRAN (R 4.2.2)
 tidyr          * 1.3.0      2023-01-24 [1] CRAN (R 4.2.2)
 tidyselect       1.2.0      2022-10-10 [1] CRAN (R 4.2.2)
 tidyverse      * 2.0.0      2023-02-22 [1] CRAN (R 4.2.2)
 timechange       0.2.0      2023-01-11 [1] CRAN (R 4.2.2)
 tzdb             0.4.0      2023-05-12 [1] CRAN (R 4.2.2)
 urlchecker       1.0.1      2021-11-30 [1] CRAN (R 4.2.2)
 usethis          2.1.6      2022-05-25 [1] CRAN (R 4.2.2)
 utf8             1.2.3      2023-01-31 [1] CRAN (R 4.2.2)
 vctrs            0.6.2      2023-04-19 [1] CRAN (R 4.2.2)
 viridisLite      0.4.2      2023-05-02 [1] CRAN (R 4.2.2)
 vmstools         0.76       2022-11-24 [1] Github (nielshintzen/vmstools@b1a1a70)
 withr            2.5.0      2022-03-03 [1] CRAN (R 4.2.2)
 xfun             0.37       2023-01-31 [1] CRAN (R 4.2.2)
 xml2             1.3.4      2023-04-27 [1] CRAN (R 4.2.2)
 xtable           1.8-4      2019-04-21 [1] CRAN (R 4.2.2)

 [1] /home/haf/einarhj/R/x86_64-pc-linux-gnu-library/4.2
 [2] /usr/local/lib/R/site/x86_64-pc-linux-gnu-library/4.2
 [3] /usr/lib/R/library

──────────────────────────────────────────────────────────────────────────────
> 
